<a href="/quran" class="btn btn-outline-secondary mb-4">
    <i class="bi bi-arrow-left"></i> Back to Surahs
</a>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0 arabic-text"><%= surah.name %></h3>
                <h5 class="mb-0"><%= surah.transliteration %> - <%= surah.translation %></h5>
            </div>
            <span class="badge bg-light text-dark"><%= surah.totalAyahs %> Ayahs</span>
        </div>
    </div>
    
    <!-- Translation Selection -->
    <div class="card-body border-bottom">
        <div class="row g-3">
            <!-- Bengali Translations -->
            <div class="col-md-6">
                <h6 class="mb-2"><i class="bi bi-translate text-success me-1"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</h6>
                <div class="d-flex flex-wrap gap-2">
                    <% config.translationsByLanguage.bangla.forEach(t => { %>
                    <div class="form-check">
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
            </div>
            <!-- English Translations -->
            <div class="col-md-6">
                <h6 class="mb-2"><i class="bi bi-translate text-primary me-1"></i> English Translation</h6>
                <div class="d-flex flex-wrap gap-2">
                    <% config.translationsByLanguage.english.forEach(t => { %>
                    <div class="form-check">
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Player Section -->
    <div class="card-body border-top">
        <div class="d-flex flex-column gap-3">
            
            <!-- Arabic Reciter Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="arabicReciterSection" data-language="arabic" style="display: none;">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ï‡¶æ‡¶∞‡ßÄ:</label>
                <% if (config.audio.reciters.arabic.length > 1) { %>
                <select class="form-select form-select-sm reciter-select" id="arabicReciterSelect" data-language="arabic" style="max-width: 280px;">
                    <% config.audio.reciters.arabic.forEach(r => { %>
                    <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                    <% }) %>
                </select>
                <% } else { %>
                <span class="badge bg-success"><%= config.audio.reciters.arabic[0].name %></span>
                <% } %>
            </div>
            
            <!-- Urdu Reciter Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="urduReciterSection" data-language="urdu" style="display: none;">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶â‡¶∞‡ßç‡¶¶‡ßÅ ‡¶ï‡¶æ‡¶∞‡ßÄ:</label>
                <% if (config.audio.reciters.urdu.length > 1) { %>
                <select class="form-select form-select-sm reciter-select" id="urduReciterSelect" data-language="urdu" style="max-width: 280px;">
                    <% config.audio.reciters.urdu.forEach(r => { %>
                    <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                    <% }) %>
                </select>
                <% } else { %>
                <span class="badge bg-success"><%= config.audio.reciters.urdu[0].name %></span>
                <% } %>
            </div>
            
            <!-- English Reciter Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="englishReciterSection" data-language="english" style="display: none;">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> English Reciter:</label>
                <% if (config.audio.reciters.english.length > 1) { %>
                <select class="form-select form-select-sm reciter-select" id="englishReciterSelect" data-language="english" style="max-width: 280px;">
                    <% config.audio.reciters.english.forEach(r => { %>
                    <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                    <% }) %>
                </select>
                <% } else { %>
                <span class="badge bg-primary"><%= config.audio.reciters.english[0].name %></span>
                <% } %>
            </div>

            <!-- Audio Type Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <label class="form-label mb-0"><i class="bi bi-translate"></i> Audio Type:</label>
                <div class="btn-group" role="group">
                    <% config.audio.types.forEach((type, index) => { %>
                    <input type="radio" class="btn-check" name="audioType" id="audio<%= type.id.charAt(0).toUpperCase() + type.id.slice(1) %>" value="<%= type.id %>" <%= index === 0 ? 'checked' : '' %>>
                    <label class="btn btn-outline-success btn-sm" for="audio<%= type.id.charAt(0).toUpperCase() + type.id.slice(1) %>"><%= type.labelBn ? type.labelBn + ' (' + type.label + ')' : type.label %></label>
                    <% }) %>
                </div>
            </div>
            
            
            <!-- Full Surah Player -->
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <button class="btn btn-success" id="playSurahBtn">
                    <i class="bi bi-play-fill"></i> Play Full Surah
                </button>
                <button class="btn btn-outline-secondary" id="stopSurahBtn" style="display: none;">
                    <i class="bi bi-stop-fill"></i> Stop
                </button>
                <span id="nowPlaying" class="text-muted small"></span>
            </div>
            
            <!-- Audio Element for Full Surah -->
            <audio id="surahAudio" class="w-100" controls style="display: none;"></audio>
        </div>
    </div>
</div>

<!-- Pagination Controls (Top) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-between align-items-center mb-3 pagination-controls flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0 small">‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§/‡¶™‡ßá‡¶ú:</label>
        <select class="form-select form-select-sm" id="ayahsPerPage" style="width: auto;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">‡¶∏‡¶¨</option>
        </select>
    </div>
    <span class="text-muted small" id="pageInfo"></span>
    <nav aria-label="Ayah pagination">
        <ul class="pagination pagination-sm mb-0" id="paginationTop"></ul>
    </nav>
</div>
<% } %>

<!-- Ayahs Container -->
<div id="ayahsContainer">
<!-- Ayahs with individual play buttons -->
<% if (surah.ayahs && surah.ayahs.length > 0) { %>
    <% surah.ayahs.forEach(ayah => { %>
        <div class="card ayah-card ayah-item" id="ayah-<%= ayah.number %>" data-ayah-number="<%= ayah.number %>">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success"><%= ayah.number %></span>
                        <button class="btn btn-sm btn-outline-success play-ayah-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                title="Play this Ayah">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary share-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-surah-name="<%= surah.transliteration %>"
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translation %>"
                                title="Share this Ayah">
                            <i class="bi bi-share"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning bookmark-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translation %>"
                                title="Bookmark this Ayah">
                            <i class="bi bi-bookmark"></i>
                        </button>
                    </div>
                </div>
                <p class="arabic-text" id="arabic-<%= ayah.number %>"><%= ayah.text %></p>
                
                <!-- Bengali Translations -->
                <div class="translation-taisirul bangla-translation">
                    <p class="translation-text mb-2">
                        <span class="badge bg-success me-1">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                        <small class="text-muted fw-semibold">‡¶Æ‡ßÅ‡¶π‡¶ø‡¶â‡¶¶‡ßç‡¶¶‡ßÄ‡¶® ‡¶ñ‡¶æ‡¶®:</small>
                        <br><%= ayah.translation %>
                    </p>
                </div>
                <% if (ayah.banglaMujibur) { %>
                <div class="translation-mujibur bangla-translation" style="display: none;">
                    <p class="translation-text mb-2">
                        <span class="badge bg-success me-1">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                        <small class="text-muted fw-semibold">‡¶ú‡¶π‡ßÅ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï:</small>
                        <br><%= ayah.banglaMujibur %>
                    </p>
                </div>
                <% } %>
                
                <!-- English Translations -->
                <% if (ayah.englishTranslation) { %>
                <div class="translation-sahih english-translation">
                    <p class="translation-text text-muted mb-2">
                        <span class="badge bg-secondary me-1">English</span>
                        <small class="fw-semibold">Sahih International:</small>
                        <br><%= ayah.englishTranslation %>
                    </p>
                </div>
                <% } %>
                <% if (ayah.englishPickthall) { %>
                <div class="translation-pickthall english-translation" style="display: none;">
                    <p class="translation-text text-muted mb-2">
                        <span class="badge bg-secondary me-1">English</span>
                        <small class="fw-semibold">Pickthall:</small>
                        <br><%= ayah.englishPickthall %>
                    </p>
                </div>
                <% } %>
                <% if (ayah.englishYusufali) { %>
                <div class="translation-yusufali english-translation" style="display: none;">
                    <p class="translation-text text-muted mb-2">
                        <span class="badge bg-secondary me-1">English</span>
                        <small class="fw-semibold">Yusuf Ali:</small>
                        <br><%= ayah.englishYusufali %>
                    </p>
                </div>
                <% } %>
                <% if (ayah.englishArberry) { %>
                <div class="translation-arberry english-translation" style="display: none;">
                    <p class="translation-text text-muted mb-2">
                        <span class="badge bg-secondary me-1">English</span>
                        <small class="fw-semibold">Arberry:</small>
                        <br><%= ayah.englishArberry %>
                    </p>
                </div>
                <% } %>
            </div>
        </div>
    <% }) %>
<% } else { %>
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        Could not load ayahs. Please try refreshing the page or check your internet connection.
    </div>
<% } %>
</div>

<!-- Pagination Controls (Bottom) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-center mt-3">
    <nav aria-label="Ayah pagination bottom">
        <ul class="pagination" id="paginationBottom"></ul>
    </nav>
</div>
<% } %>

<!-- Hidden audio element for ayah playback -->
<audio id="ayahAudio"></audio>

<!-- Fixed Bottom Audio Player Control Bar -->
<div id="audioPlayerBar" class="audio-player-bar">
    <div class="player-container">
        <!-- Progress Bar -->
        <div class="progress-section">
            <span class="time-display" id="currentTime">0:00</span>
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
            </div>
            <span class="time-display" id="totalTime">0:00</span>
        </div>
        
        <!-- Main Controls -->
        <div class="controls-section">
            <!-- Left Controls -->
            <div class="controls-left">
                <div class="speed-dropdown">
                    <select class="speed-select" id="speedSelect" title="Playback Speed">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <button class="player-btn" id="repeatBtn" title="Repeat Mode">
                    <i class="bi bi-repeat"></i>
                </button>
            </div>
            
            <!-- Center Controls -->
            <div class="controls-center">
                <button class="player-btn nav-btn" id="prevAyahBtn" title="Previous Ayah">
                    <i class="bi bi-skip-backward-fill"></i>
                </button>
                <button class="player-btn play-pause-btn" id="mainPlayPauseBtn" title="Play/Pause">
                    <i class="bi bi-play-fill" id="playPauseIcon"></i>
                </button>
                <button class="player-btn nav-btn" id="nextAyahBtn" title="Next Ayah">
                    <i class="bi bi-skip-forward-fill"></i>
                </button>
            </div>
            
            <!-- Right Controls -->
            <div class="controls-right">
                <div class="volume-control">
                    <button class="player-btn volume-btn" id="volumeBtn" title="Volume">
                        <i class="bi bi-volume-up-fill" id="volumeIcon"></i>
                    </button>
                    <div class="volume-slider-container" id="volumeSliderContainer">
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
                    </div>
                </div>
                <button class="player-btn" id="autoPlayToggle" title="Auto-play next ayah">
                    <i class="bi bi-collection-play"></i>
                </button>
            </div>
        </div>
        
        <!-- Now Playing Info -->
        <div class="now-playing-section">
            <div class="now-playing-info">
                <span class="surah-name"><%= surah.transliteration %></span>
                <span class="ayah-indicator" id="playerAyahIndicator">Select an ayah to play</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // DYNAMIC CONFIGURATION (from server)
    // ============================================
    const APP_CONFIG = <%- JSON.stringify(config) %>;
    
    // Surah and ayah counts for audio URL generation
    const SURAH_AYAH_COUNTS = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6];
    
    const surahId = <%= surah.id %>;
    const totalAyahs = <%= surah.totalAyahs %>;
    
    // Calculate global ayah number
    function getGlobalAyahNumber(surahId, ayahNumber) {
        let globalNumber = 0;
        for (let i = 0; i < surahId - 1; i++) {
            globalNumber += SURAH_AYAH_COUNTS[i];
        }
        return globalNumber + ayahNumber;
    }
    
    // Get Arabic ayah audio URL (everyayah.com - reliable source)
    function getArabicAyahAudioUrl(surahId, ayahNumber, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        return `https://everyayah.com/data/${reciterFolder}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get Urdu translation audio URL (uses reciter ID from config)
    function getUrduAyahAudioUrl(surahId, ayahNumber, reciterId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Use the reciter ID directly (it's the folder name)
        return `https://everyayah.com/data/translations/${reciterId}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get English translation audio URL (uses reciter ID from config)
    function getEnglishAyahAudioUrl(surahId, ayahNumber, reciterId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Use the reciter ID directly (it's the folder path like 'English/Sahih_Intnl_Ibrahim_Walk_192kbps')
        return `https://everyayah.com/data/${reciterId}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get full surah audio URL (quranicaudio.com)
    function getSurahAudioUrl(surahId, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        return `https://download.quranicaudio.com/quran/${reciterFolder}/${paddedSurah}.mp3`;
    }
    
    // ============================================
    // DYNAMIC AUDIO HELPERS
    // ============================================
    
    // Get default reciter ID for a language
    function getDefaultReciter(language) {
        const reciters = APP_CONFIG.audio.reciters[language];
        if (!reciters || reciters.length === 0) return null;
        const defaultReciter = reciters.find(r => r.isDefault);
        return defaultReciter ? defaultReciter.id : reciters[0].id;
    }
    
    // Get selected reciter for a language (from dropdown or default)
    function getSelectedReciter(language) {
        const select = document.getElementById(`${language}ReciterSelect`);
        if (select) {
            return select.value;
        }
        return getDefaultReciter(language);
    }
    
    // Audio elements
    const surahAudio = document.getElementById('surahAudio');
    const ayahAudio = document.getElementById('ayahAudio');
    const playSurahBtn = document.getElementById('playSurahBtn');
    const stopSurahBtn = document.getElementById('stopSurahBtn');
    const nowPlaying = document.getElementById('nowPlaying');
    
    // Dynamic reciter sections
    const reciterSections = {};
    APP_CONFIG.audio.types.forEach(type => {
        type.showsReciters.forEach(lang => {
            if (!reciterSections[lang]) {
                reciterSections[lang] = document.getElementById(`${lang}ReciterSection`);
            }
        });
    });
    
    // Audio type radio buttons
    const audioTypeRadios = document.querySelectorAll('input[name="audioType"]');
    
    let currentlyPlayingAyah = null;
    let isPlayingSequence = false;
    let currentAudioType = 'arabic';
    let isPlayingTranslationAfterArabic = false;
    
    // Hidden audio element for translation playback in "Both" mode
    const translationAudio = document.createElement('audio');
    translationAudio.id = 'translationAudio';
    document.body.appendChild(translationAudio);
    
    // Get current audio type
    function getAudioType() {
        const selected = document.querySelector('input[name="audioType"]:checked');
        return selected ? selected.value : 'arabic';
    }
    
    // Get translation language for "both" mode
    function getTranslationLanguage() {
        return localStorage.getItem('translationLanguage') || 'english';
    }
    
    // Function to update reciter section visibility based on audio type (DYNAMIC)
    function updateReciterSectionVisibility(audioType) {
        // Hide all reciter sections first
        Object.values(reciterSections).forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // Find the audio type config
        const audioTypeConfig = APP_CONFIG.audio.types.find(t => t.id === audioType);
        if (!audioTypeConfig) return;
        
        // Show the relevant sections
        audioTypeConfig.showsReciters.forEach(lang => {
            const section = reciterSections[lang];
            if (section) section.style.display = 'flex';
        });
    }
    
    // Handle audio type change
    audioTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            currentAudioType = getAudioType();
            updateReciterSectionVisibility(currentAudioType);
            localStorage.setItem('audioType', currentAudioType);
        });
    });
    
    // Initialize: Load saved audio type and update visibility
    const savedAudioType = localStorage.getItem('audioType') || 'arabic';
    const savedRadio = document.querySelector(`input[name="audioType"][value="${savedAudioType}"]`);
    if (savedRadio) {
        savedRadio.checked = true;
    }
    currentAudioType = savedAudioType;
    // Call visibility update after a small delay to ensure DOM is ready
    setTimeout(() => {
        updateReciterSectionVisibility(savedAudioType);
    }, 0);
    
    // Load saved reciter preferences for all languages dynamically
    Object.keys(APP_CONFIG.audio.reciters).forEach(language => {
        const savedKey = `preferredReciter_${language}`;
        const savedReciter = localStorage.getItem(savedKey);
        const select = document.getElementById(`${language}ReciterSelect`);
        
        if (select && savedReciter) {
            select.value = savedReciter;
        }
        
        // Save preference on change
        if (select) {
            select.addEventListener('change', () => {
                localStorage.setItem(savedKey, select.value);
            });
        }
    });
    
    // Migration: old 'preferredReciter' to new format
    const oldSavedReciter = localStorage.getItem('preferredReciter');
    if (oldSavedReciter) {
        const arabicSelect = document.getElementById('arabicReciterSelect');
        if (arabicSelect) {
            // Check if it's an old format value and migrate
            const oldToNewMap = {
                'ar.alafasy': 'Alafasy_128kbps',
                'ar.abdulbasitmurattal': 'Abdul_Basit_Murattal_192kbps',
                'ar.abdulsamad': 'Abdul_Basit_Mujawwad_128kbps',
                'ar.husary': 'Husary_128kbps',
                'ar.minshawi': 'Minshawy_Murattal_128kbps',
                'ar.ahmedajamy': 'Ahmed_ibn_Ali_al_Ajamy_128kbps_ketaballah.net',
                'ar.muhammadayyoub': 'Muhammad_Ayyoub_128kbps',
                'ar.muhammadjibreel': 'Muhammad_Jibreel_128kbps'
            };
            const newValue = oldToNewMap[oldSavedReciter] || oldSavedReciter;
            arabicSelect.value = newValue;
            localStorage.setItem('preferredReciter_arabic', newValue);
            localStorage.removeItem('preferredReciter'); // Clean up old key
        }
    }
    
    // Play full surah (Arabic only - translations play ayah by ayah)
    playSurahBtn.addEventListener('click', () => {
        const audioType = getAudioType();
        
        if (audioType === 'urdu' || audioType === 'english') {
            // For translations, play ayah by ayah starting from first
            const firstAyahBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstAyahBtn) {
                firstAyahBtn.click();
            }
            return;
        }
        
        const reciterId = getSelectedReciter('arabic') || getDefaultReciter('arabic');
        const audioUrl = getSurahAudioUrl(surahId, reciterId);
        
        surahAudio.src = audioUrl;
        surahAudio.style.display = 'block';
        surahAudio.play();
        
        playSurahBtn.style.display = 'none';
        stopSurahBtn.style.display = 'inline-block';
        nowPlaying.textContent = audioType === 'both' ? 'Playing full surah (Arabic)...' : 'Playing full surah...';
    });
    
    // Stop surah
    stopSurahBtn.addEventListener('click', () => {
        surahAudio.pause();
        surahAudio.currentTime = 0;
        surahAudio.style.display = 'none';
        
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // When surah audio ends
    surahAudio.addEventListener('ended', () => {
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // Play individual ayah
    document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const audioType = getAudioType();
            const arabicReciterId = getSelectedReciter('arabic') || getDefaultReciter('arabic');
            
            // Stop surah audio if playing
            surahAudio.pause();
            playSurahBtn.style.display = 'inline-block';
            stopSurahBtn.style.display = 'none';
            surahAudio.style.display = 'none';
            
            // Reset translation state
            isPlayingTranslationAfterArabic = false;
            translationAudio.pause();
            
            // Reset previous playing button and card highlight
            if (currentlyPlayingAyah) {
                const prevBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
                if (prevBtn) {
                    prevBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    prevBtn.classList.remove('btn-success', 'playing');
                    prevBtn.classList.add('btn-outline-success');
                }
                const prevCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
                if (prevCard) {
                    prevCard.classList.remove('playing', 'border-success');
                }
            }
            
            // If clicking same ayah, toggle
            if (currentlyPlayingAyah === ayahNumber && !ayahAudio.paused) {
                ayahAudio.pause();
                translationAudio.pause();
                btn.innerHTML = '<i class="bi bi-play-fill"></i>';
                btn.classList.remove('btn-success', 'playing');
                btn.classList.add('btn-outline-success');
                document.getElementById(`ayah-${ayahNumber}`).classList.remove('playing', 'border-success');
                currentlyPlayingAyah = null;
                nowPlaying.textContent = '';
                return;
            }
            
            // Determine which audio to play based on type (using dynamic config)
            let audioUrl;
            if (audioType === 'arabic' || audioType === 'both') {
                audioUrl = getArabicAyahAudioUrl(surahId, ayahNumber, arabicReciterId);
            } else if (audioType === 'urdu') {
                const urduReciterId = getSelectedReciter('urdu') || getDefaultReciter('urdu');
                audioUrl = getUrduAyahAudioUrl(surahId, ayahNumber, urduReciterId);
            } else if (audioType === 'english') {
                const englishReciterId = getSelectedReciter('english') || getDefaultReciter('english');
                audioUrl = getEnglishAyahAudioUrl(surahId, ayahNumber, englishReciterId);
            }
            
            // Play the audio
            ayahAudio.src = audioUrl;
            ayahAudio.play().catch(err => console.error('Play error:', err));
            
            btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
            btn.classList.add('btn-success', 'playing');
            btn.classList.remove('btn-outline-success');
            currentlyPlayingAyah = ayahNumber;
            
            // Set status text based on audio type (dynamic)
            const audioTypeConfig = APP_CONFIG.audio.types.find(t => t.id === audioType);
            if (audioType === 'both') {
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶§‡ßá‡¶≤‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶§`;
            } else if (audioTypeConfig) {
                const label = audioTypeConfig.labelBn || audioTypeConfig.label;
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ${label}`;
            } else {
                nowPlaying.textContent = `Playing Ayah ${ayahNumber}`;
            }
            
            // Highlight current ayah with playing animation
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
            const currentCard = document.getElementById(`ayah-${ayahNumber}`);
            currentCard.classList.add('playing');
            currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });
    
    // When ayah audio ends - handled by bottom player bar code
    // (See the comprehensive handler in the Bottom Audio Player Bar Controls section)
    
    // When translation audio ends (for "Both" mode) - handled by bottom player bar code
    // (See the comprehensive handler in the Bottom Audio Player Bar Controls section)
    
    // Bookmark functionality
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    
    // Update bookmark button icons on load
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        const surahId = parseInt(btn.dataset.surahId);
        const ayahNumber = parseInt(btn.dataset.ayahNumber);
        const isBookmarked = bookmarks.some(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
        if (isBookmarked) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
        }
    });
    
    // Handle bookmark toggle
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const surahId = parseInt(btn.dataset.surahId);
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const text = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            const index = bookmarks.findIndex(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
            
            if (index > -1) {
                bookmarks.splice(index, 1);
                btn.innerHTML = '<i class="bi bi-bookmark"></i>';
            } else {
                bookmarks.push({ surahId, ayahNumber, text, translation });
                btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        });
    });
    
    // Share functionality
    function showShareToast(message) {
        const toast = document.createElement('div');
        toast.className = 'share-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const surahId = btn.dataset.surahId;
            const surahName = btn.dataset.surahName;
            const ayahNumber = btn.dataset.ayahNumber;
            const arabicText = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            // Get current page from URL
            const params = new URLSearchParams(window.location.search);
            const currentPage = params.get('page');
            
            // Build URL with page parameter if present
            let shareUrl = `${window.location.origin}/surah/${surahId}`;
            if (currentPage && currentPage !== '1') {
                shareUrl += `?page=${currentPage}`;
            }
            shareUrl += `#ayah-${ayahNumber}`;
            
            const shareText = `üìñ ‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}\n\n${arabicText}\n\n${translation}\n\nüîó ${shareUrl}`;
            
            // Always copy to clipboard first
            await copyToClipboard(shareText, shareUrl);
            
            // Then try Web Share API (mobile-friendly)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}`,
                        text: shareText,
                        url: shareUrl
                    });
                } catch (err) {
                    // User cancelled or error - clipboard already copied
                }
            }
        });
    });
    
    async function copyToClipboard(text, url) {
        console.log('Copying to clipboard:', url);
        try {
            await navigator.clipboard.writeText(url);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        } catch {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = url;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        }
    }
    
    // =========================================
    // Bottom Audio Player Bar Controls
    // =========================================
    const playerBar = document.getElementById('audioPlayerBar');
    const mainPlayPauseBtn = document.getElementById('mainPlayPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const prevAyahBtn = document.getElementById('prevAyahBtn');
    const nextAyahBtn = document.getElementById('nextAyahBtn');
    const speedSelect = document.getElementById('speedSelect');
    const repeatBtn = document.getElementById('repeatBtn');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const autoPlayToggle = document.getElementById('autoPlayToggle');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBarFill = document.getElementById('progressBarFill');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const playerAyahIndicator = document.getElementById('playerAyahIndicator');
    
    // Player state
    let isAutoPlayEnabled = true;
    let repeatMode = 'none'; // 'none', 'one', 'all'
    let playbackSpeed = 1;
    
    // Load saved preferences
    const savedAutoPlay = localStorage.getItem('autoPlayEnabled');
    if (savedAutoPlay !== null) {
        isAutoPlayEnabled = savedAutoPlay === 'true';
    }
    autoPlayToggle.classList.toggle('active', isAutoPlayEnabled);
    
    const savedRepeat = localStorage.getItem('repeatMode');
    if (savedRepeat) {
        repeatMode = savedRepeat;
        updateRepeatButton();
    }
    
    const savedVolume = localStorage.getItem('playerVolume');
    if (savedVolume) {
        volumeSlider.value = savedVolume;
        ayahAudio.volume = savedVolume / 100;
        translationAudio.volume = savedVolume / 100;
        updateVolumeIcon(savedVolume);
    }
    
    const savedSpeed = localStorage.getItem('playbackSpeed');
    if (savedSpeed) {
        playbackSpeed = parseFloat(savedSpeed);
        speedSelect.value = savedSpeed;
        ayahAudio.playbackRate = playbackSpeed;
        translationAudio.playbackRate = playbackSpeed;
    }
    
    // Show player bar when there's an ayah to play
    function showPlayerBar() {
        playerBar.classList.add('active');
    }
    
    function hidePlayerBar() {
        playerBar.classList.remove('active');
    }
    
    // Format time (seconds to mm:ss)
    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update progress bar
    ayahAudio.addEventListener('timeupdate', () => {
        if (ayahAudio.duration) {
            const progress = (ayahAudio.currentTime / ayahAudio.duration) * 100;
            progressBarFill.style.width = progress + '%';
            currentTimeDisplay.textContent = formatTime(ayahAudio.currentTime);
        }
    });
    
    ayahAudio.addEventListener('loadedmetadata', () => {
        totalTimeDisplay.textContent = formatTime(ayahAudio.duration);
    });
    
    ayahAudio.addEventListener('play', () => {
        playPauseIcon.className = 'bi bi-pause-fill';
        mainPlayPauseBtn.classList.add('playing');
        showPlayerBar();
    });
    
    ayahAudio.addEventListener('pause', () => {
        if (!isPlayingTranslationAfterArabic) {
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
        }
    });
    
    // Translation audio events for "Both" mode
    translationAudio.addEventListener('play', () => {
        playPauseIcon.className = 'bi bi-pause-fill';
        mainPlayPauseBtn.classList.add('playing');
    });
    
    translationAudio.addEventListener('timeupdate', () => {
        if (isPlayingTranslationAfterArabic && translationAudio.duration) {
            const progress = (translationAudio.currentTime / translationAudio.duration) * 100;
            progressBarFill.style.width = progress + '%';
            currentTimeDisplay.textContent = formatTime(translationAudio.currentTime);
            totalTimeDisplay.textContent = formatTime(translationAudio.duration);
        }
    });
    
    // Click on progress bar to seek
    progressBarContainer.addEventListener('click', (e) => {
        const rect = progressBarContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        const percent = clickX / width;
        
        if (isPlayingTranslationAfterArabic) {
            translationAudio.currentTime = percent * translationAudio.duration;
        } else if (ayahAudio.duration) {
            ayahAudio.currentTime = percent * ayahAudio.duration;
        }
    });
    
    // Main play/pause button
    mainPlayPauseBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah) {
            if (isPlayingTranslationAfterArabic) {
                if (translationAudio.paused) {
                    translationAudio.play();
                } else {
                    translationAudio.pause();
                }
            } else {
                if (ayahAudio.paused) {
                    ayahAudio.play();
                } else {
                    ayahAudio.pause();
                }
            }
        } else {
            // Start playing from first ayah
            const firstAyahBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstAyahBtn) {
                firstAyahBtn.click();
            }
        }
    });
    
    // Previous ayah button
    prevAyahBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah && currentlyPlayingAyah > 1) {
            // Stop current playback
            ayahAudio.pause();
            translationAudio.pause();
            isPlayingTranslationAfterArabic = false;
            
            const prevAyah = currentlyPlayingAyah - 1;
            const prevBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${prevAyah}"]`);
            if (prevBtn) {
                prevBtn.click();
            }
        }
    });
    
    // Next ayah button
    nextAyahBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah && currentlyPlayingAyah < totalAyahs) {
            // Stop current playback
            ayahAudio.pause();
            translationAudio.pause();
            isPlayingTranslationAfterArabic = false;
            
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                nextBtn.click();
            }
        }
    });
    
    // Speed control dropdown
    speedSelect.addEventListener('change', () => {
        playbackSpeed = parseFloat(speedSelect.value);
        ayahAudio.playbackRate = playbackSpeed;
        translationAudio.playbackRate = playbackSpeed;
        localStorage.setItem('playbackSpeed', playbackSpeed);
    });
    
    // Repeat mode toggle
    function updateRepeatButton() {
        if (repeatMode === 'none') {
            repeatBtn.classList.remove('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat"></i>';
        } else if (repeatMode === 'one') {
            repeatBtn.classList.add('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat-1"></i>';
        } else {
            repeatBtn.classList.add('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat"></i>';
        }
    }
    
    repeatBtn.addEventListener('click', () => {
        if (repeatMode === 'none') {
            repeatMode = 'one';
        } else if (repeatMode === 'one') {
            repeatMode = 'all';
        } else {
            repeatMode = 'none';
        }
        updateRepeatButton();
        localStorage.setItem('repeatMode', repeatMode);
    });
    
    // Volume control
    function updateVolumeIcon(value) {
        if (value == 0) {
            volumeIcon.className = 'bi bi-volume-mute-fill';
        } else if (value < 50) {
            volumeIcon.className = 'bi bi-volume-down-fill';
        } else {
            volumeIcon.className = 'bi bi-volume-up-fill';
        }
    }
    
    volumeSlider.addEventListener('input', () => {
        const value = volumeSlider.value;
        ayahAudio.volume = value / 100;
        translationAudio.volume = value / 100;
        surahAudio.volume = value / 100;
        updateVolumeIcon(value);
        localStorage.setItem('playerVolume', value);
    });
    
    let previousVolume = 100;
    volumeBtn.addEventListener('click', () => {
        if (volumeSlider.value > 0) {
            previousVolume = volumeSlider.value;
            volumeSlider.value = 0;
        } else {
            volumeSlider.value = previousVolume;
        }
        volumeSlider.dispatchEvent(new Event('input'));
    });
    
    // Auto-play toggle
    autoPlayToggle.addEventListener('click', () => {
        isAutoPlayEnabled = !isAutoPlayEnabled;
        autoPlayToggle.classList.toggle('active', isAutoPlayEnabled);
        localStorage.setItem('autoPlayEnabled', isAutoPlayEnabled);
    });
    
    // Update player bar ayah indicator when playing
    function updatePlayerBarInfo(ayahNumber) {
        if (ayahNumber) {
            const audioType = getAudioType();
            let audioTypeText = '‡¶Ü‡¶∞‡¶¨‡¶ø';
            if (audioType === 'urdu') audioTypeText = '‡¶â‡¶∞‡ßç‡¶¶‡ßÅ';
            else if (audioType === 'english') audioTypeText = 'English';
            else if (audioType === 'both') audioTypeText = 'Arabic + Translation';
            
            playerAyahIndicator.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} ‚Ä¢ ${audioTypeText}`;
        } else {
            playerAyahIndicator.textContent = 'Select an ayah to play';
        }
    }
    
    // Override existing ayah button click to update player bar
    const originalPlayHandler = (btn) => {
        btn.addEventListener('click', () => {
            showPlayerBar();
            updatePlayerBarInfo(parseInt(btn.dataset.ayahNumber));
        });
    };
    
    document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        originalPlayHandler(btn);
    });
    
    // Update the ayahAudio ended handler to use autoplay setting and repeat mode
    ayahAudio.removeEventListener('ended', () => {});
    ayahAudio.addEventListener('ended', () => {
        const audioType = getAudioType();
        
        // If in "both" mode and Arabic just finished, play English translation
        if (audioType === 'both' && !isPlayingTranslationAfterArabic) {
            isPlayingTranslationAfterArabic = true;
            const englishReciterId = getSelectedReciter('english') || getDefaultReciter('english');
            const translationUrl = getEnglishAyahAudioUrl(surahId, currentlyPlayingAyah, englishReciterId);
            translationAudio.src = translationUrl;
            translationAudio.playbackRate = playbackSpeed;
            translationAudio.play();
            nowPlaying.textContent = `Ayah ${currentlyPlayingAyah} - English Translation`;
            updatePlayerBarInfo(currentlyPlayingAyah);
            return;
        }
        
        // Check repeat mode
        if (repeatMode === 'one') {
            ayahAudio.currentTime = 0;
            ayahAudio.play();
            return;
        }
        
        // Reset translation state
        isPlayingTranslationAfterArabic = false;
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah if enabled
        if (isAutoPlayEnabled && currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else if (repeatMode === 'all' && currentlyPlayingAyah >= totalAyahs) {
            // Loop back to first ayah
            const firstBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstBtn) {
                document.getElementById('ayah-1').scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
            updatePlayerBarInfo(null);
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // Update translation audio ended handler
    translationAudio.removeEventListener('ended', () => {});
    translationAudio.addEventListener('ended', () => {
        isPlayingTranslationAfterArabic = false;
        
        // Check repeat mode for "both" audio type
        if (repeatMode === 'one') {
            // Restart from Arabic
            const currentBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
            if (currentBtn) {
                setTimeout(() => currentBtn.click(), 200);
            }
            return;
        }
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah if enabled
        if (isAutoPlayEnabled && currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else if (repeatMode === 'all' && currentlyPlayingAyah >= totalAyahs) {
            // Loop back to first ayah
            const firstBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstBtn) {
                document.getElementById('ayah-1').scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
            updatePlayerBarInfo(null);
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // Keyboard shortcuts for player
    document.addEventListener('keydown', (e) => {
        // Don't trigger if typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }
        
        switch(e.code) {
            case 'Space':
                e.preventDefault();
                mainPlayPauseBtn.click();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                prevAyahBtn.click();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextAyahBtn.click();
                break;
            case 'ArrowUp':
                e.preventDefault();
                volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
                volumeSlider.dispatchEvent(new Event('input'));
                break;
            case 'ArrowDown':
                e.preventDefault();
                volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
                volumeSlider.dispatchEvent(new Event('input'));
                break;
            case 'KeyR':
                repeatBtn.click();
                break;
        }
    });
</script>

<style>
    /* Translation checkbox styling */
    .form-check {
        padding-left: 1.75em;
    }
    
    .translation-checkbox:checked {
        background-color: #198754;
        border-color: #198754;
    }
    
    .translation-text small.fw-semibold {
        display: inline-block;
        margin-bottom: 0.25rem;
    }
    
    /* Dark mode for translation section */
    [data-bs-theme="dark"] .card-body h6 {
        color: #fff;
    }
    
    [data-bs-theme="dark"] .form-check-label {
        color: #e0e0e0;
    }
    
    /* Playing ayah card - enhanced highlight */
    .ayah-card.playing {
        border-left: 5px solid #871983 !important;
        background: linear-gradient(90deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.05) 50%, transparent 100%);
        animation: pulse-highlight 2s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(25, 135, 84, 0.4);
        transform: scale(1.01);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Playing indicator bar */
    .ayah-card.playing::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(180deg, #198754, #20c997, #198754);
        animation: gradient-flow 2s linear infinite;
    }
    
    /* Sound wave indicator */
    .ayah-card.playing::after {
        /* content: 'üîä'; */
        content: '';
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
        animation: sound-wave 1s ease-in-out infinite;
    }
    
    .ayah-card.playing .arabic-text {
        color: #146c43;
        font-weight: 600;
        animation: text-glow 2s ease-in-out infinite;
    }
    
    [data-bs-theme="dark"] .ayah-card.playing {
        background: linear-gradient(90deg, rgba(25, 135, 84, 0.3) 0%, rgba(25, 135, 84, 0.15) 50%, rgba(25, 135, 84, 0.05) 100%);
        box-shadow: 0 0 30px rgba(25, 135, 84, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.playing .arabic-text {
        color: #75b798;
    }
    
    @keyframes pulse-highlight {
        0%, 100% {
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.3);
        }
        50% {
            box-shadow: 0 0 30px rgba(25, 135, 84, 0.6);
        }
    }
    
    @keyframes gradient-flow {
        0% { background-position: 0% 0%; }
        100% { background-position: 0% 200%; }
    }
    
    @keyframes sound-wave {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    @keyframes text-glow {
        0%, 100% { text-shadow: 0 0 5px rgba(25, 135, 84, 0.3); }
        50% { text-shadow: 0 0 15px rgba(25, 135, 84, 0.6); }
    }
    
    .ayah-card.border-success {
        border-left-color: #198754 !important;
        border-width: 4px;
        background-color: rgba(25, 135, 84, 0.05);
    }
    
    [data-bs-theme="dark"] .ayah-card.border-success {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .ayah-item.hidden {
        display: none !important;
    }
    
    .pagination .page-link {
        cursor: pointer;
    }
    
    /* Now Playing button indicator */
    .play-ayah-btn.playing {
        animation: btn-pulse 1s ease-in-out infinite;
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: white !important;
    }
    
    @keyframes btn-pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
        }
    }
    
    /* Share button styles */
    .share-btn:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Toast notification */
    .share-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #198754;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: toast-slide-up 0.3s ease;
    }
    
    @keyframes toast-slide-up {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* Shared link highlight effect */
    .ayah-card.shared-highlight {
        border: 3px solid #0d6efd !important;
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.2) 0%, rgba(13, 110, 253, 0.1) 50%, rgba(13, 110, 253, 0.05) 100%);
        animation: shared-pulse 1.5s ease-in-out 3;
        box-shadow: 0 0 25px rgba(13, 110, 253, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.shared-highlight {
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.3) 0%, rgba(13, 110, 253, 0.15) 50%, rgba(13, 110, 253, 0.05) 100%);
        box-shadow: 0 0 35px rgba(13, 110, 253, 0.6);
    }
    
    @keyframes shared-pulse {
        0%, 100% {
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.4);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 35px rgba(13, 110, 253, 0.7);
            transform: scale(1.02);
        }
    }
    
    /* Fixed Bottom Audio Player Bar */
    .audio-player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border-top: 2px solid #198754;
        padding: 8px 16px;
        z-index: 1050;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .audio-player-bar.active {
        transform: translateY(0);
    }
    
    .player-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    /* Progress Section */
    .progress-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .time-display {
        font-size: 12px;
        color: #aaa;
        min-width: 40px;
        text-align: center;
        font-family: monospace;
    }
    
    .progress-bar-container {
        flex: 1;
        cursor: pointer;
        padding: 8px 0;
    }
    
    .progress-bar-bg {
        height: 6px;
        background: #333;
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #198754, #20c997);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
        position: relative;
    }
    
    .progress-bar-fill::after {
        content: '';
        position: absolute;
        right: -6px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .progress-bar-container:hover .progress-bar-fill::after {
        opacity: 1;
    }
    
    /* Controls Section */
    .controls-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .controls-left,
    .controls-right {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
    }
    
    .controls-right {
        justify-content: flex-end;
    }
    
    .controls-center {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .player-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 18px;
    }
    
    .player-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
    }
    
    .player-btn:active {
        transform: scale(0.95);
    }
    
    .player-btn.active {
        color: #198754;
    }
    
    .play-pause-btn {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #198754, #20c997);
        border-radius: 50%;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4);
    }
    
    .play-pause-btn:hover {
        background: linear-gradient(135deg, #146c43, #198754);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.6);
    }
    
    .play-pause-btn.playing {
        animation: pulse-play 2s ease-in-out infinite;
    }
    
    @keyframes pulse-play {
        0%, 100% { box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4); }
        50% { box-shadow: 0 4px 25px rgba(25, 135, 84, 0.7); }
    }
    
    .nav-btn {
        font-size: 22px;
    }
    
    /* Speed Dropdown */
    .speed-dropdown {
        position: relative;
    }
    
    .speed-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        transition: all 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 28px;
        min-width: 70px;
    }
    
    .speed-select:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: #198754;
    }
    
    .speed-select:focus {
        border-color: #198754;
        box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.3);
    }
    
    .speed-select option {
        background: #1a1a2e;
        color: #fff;
        padding: 8px;
    }
    
    [data-bs-theme="light"] .speed-select {
        background-color: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.2);
        color: #333;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    }
    
    [data-bs-theme="light"] .speed-select option {
        background: #fff;
        color: #333;
    }
    
    /* Volume Control */
    .volume-control {
        display: flex;
        align-items: center;
        position: relative;
    }
    
    .volume-slider-container {
        width: 0;
        overflow: hidden;
        transition: width 0.3s ease;
    }
    
    .volume-control:hover .volume-slider-container {
        width: 80px;
        margin-left: 8px;
    }
    
    .volume-slider {
        width: 80px;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #333;
        border-radius: 2px;
        outline: none;
    }
    
    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #198754;
        border-radius: 50%;
        cursor: pointer;
    }
    
    .volume-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: #198754;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    
    /* Now Playing Section */
    .now-playing-section {
        text-align: center;
        padding: 4px 0;
    }
    
    .now-playing-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .surah-name {
        color: #198754;
        font-weight: 600;
        font-size: 13px;
    }
    
    .ayah-indicator {
        color: #aaa;
        font-size: 12px;
    }
    
    /* Add bottom padding to content when player is active */
    body:has(.audio-player-bar.active) {
        padding-bottom: 140px;
    }
    
    /* Light mode styles */
    [data-bs-theme="light"] .audio-player-bar {
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        border-top-color: #198754;
    }
    
    [data-bs-theme="light"] .player-btn {
        color: #333;
    }
    
    [data-bs-theme="light"] .time-display {
        color: #666;
    }
    
    [data-bs-theme="light"] .progress-bar-bg {
        background: #ccc;
    }
    
    [data-bs-theme="light"] .ayah-indicator {
        color: #666;
    }
    
    [data-bs-theme="light"] .volume-slider {
        background: #ccc;
    }
    
    /* Mobile responsive */
    @media (max-width: 576px) {
        .audio-player-bar {
            padding: 6px 10px;
        }
        
        .controls-left,
        .controls-right {
            min-width: auto;
            gap: 4px;
        }
        
        .player-btn {
            padding: 6px;
            font-size: 16px;
        }
        
        .play-pause-btn {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }
        
        .nav-btn {
            font-size: 18px;
        }
        
        .volume-control:hover .volume-slider-container {
            width: 60px;
        }
        
        .speed-select {
            min-width: 60px;
            padding: 4px 24px 4px 6px;
            font-size: 11px;
        }
        
        .now-playing-info {
            font-size: 11px;
        }
        
        body:has(.audio-player-bar.active) {
            padding-bottom: 120px;
        }
    }
</style>

<script>
    // Pagination functionality
    (function() {
        const ayahItems = document.querySelectorAll('.ayah-item');
        if (ayahItems.length <= 20) return; // No pagination needed
        
        const perPageSelect = document.getElementById('ayahsPerPage');
        const pageInfo = document.getElementById('pageInfo');
        const paginationTop = document.getElementById('paginationTop');
        const paginationBottom = document.getElementById('paginationBottom');
        
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // Load saved preference
        const savedPerPage = localStorage.getItem('ayahsPerPage');
        if (savedPerPage) {
            perPageSelect.value = savedPerPage;
            itemsPerPage = savedPerPage === 'all' ? ayahItems.length : parseInt(savedPerPage);
        }
        
        // Get page from URL
        function getPageFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get('page'));
            return page && page > 0 ? page : 1;
        }
        
        // Update URL with page number
        function updateUrl(page) {
            const url = new URL(window.location);
            if (page > 1) {
                url.searchParams.set('page', page);
            } else {
                url.searchParams.delete('page');
            }
            window.history.pushState({page: page}, '', url);
        }
        
        function getTotalPages() {
            return Math.ceil(ayahItems.length / itemsPerPage);
        }
        
        function showPage(page, updateHistory = true) {
            const totalPages = getTotalPages();
            // Clamp page to valid range
            page = Math.max(1, Math.min(page, totalPages));
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            ayahItems.forEach((item, index) => {
                if (itemsPerPage === ayahItems.length || (index >= start && index < end)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
            
            updatePageInfo();
            renderPagination();
            
            // Update URL
            if (updateHistory) {
                updateUrl(page);
            }
            
            // Scroll to top of ayahs
            document.getElementById('ayahsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updatePageInfo() {
            const totalPages = getTotalPages();
            if (itemsPerPage === ayahItems.length) {
                pageInfo.textContent = `‡¶∏‡¶¨ ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§`;
            } else {
                const start = (currentPage - 1) * itemsPerPage + 1;
                const end = Math.min(currentPage * itemsPerPage, ayahItems.length);
                pageInfo.textContent = `${start}-${end} / ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ (‡¶™‡ßá‡¶ú ${currentPage}/${totalPages})`;
            }
        }
        
        function renderPagination() {
            const totalPages = getTotalPages();
            if (totalPages <= 1) {
                paginationTop.innerHTML = '';
                paginationBottom.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage - 1}">&laquo;</a>
            </li>`;
            
            // Page numbers with ellipsis
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" data-page="1">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" data-page="${i}">${i}</a>
                </li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" data-page="${totalPages}">${totalPages}</a></li>`;
            }
            
            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage + 1}">&raquo;</a>
            </li>`;
            
            paginationTop.innerHTML = html;
            paginationBottom.innerHTML = html;
            
            // Add click handlers
            document.querySelectorAll('.pagination .page-link[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.dataset.page);
                    if (page >= 1 && page <= totalPages) {
                        showPage(page);
                    }
                });
            });
        }
        
        // Handle per-page change
        perPageSelect.addEventListener('change', () => {
            const value = perPageSelect.value;
            localStorage.setItem('ayahsPerPage', value);
            itemsPerPage = value === 'all' ? ayahItems.length : parseInt(value);
            currentPage = 1;
            showPage(1);
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', (e) => {
            const page = e.state?.page || getPageFromUrl();
            showPage(page, false);
        });
        
        // Initialize with page from URL
        const initialPage = getPageFromUrl();
        showPage(initialPage, false);
        
        // Handle hash-based ayah highlighting on page load
        setTimeout(() => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#ayah-')) {
                const ayahNumber = parseInt(hash.replace('#ayah-', ''));
                const ayahCard = document.getElementById(`ayah-${ayahNumber}`);
                if (ayahCard) {
                    // Scroll to the ayah
                    ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add highlight effect
                    ayahCard.classList.add('shared-highlight');
                    
                    // Remove highlight after a few seconds
                    setTimeout(() => {
                        ayahCard.classList.remove('shared-highlight');
                    }, 5000);
                }
            }
        }, 300);
    })();
    
    // Translation visibility toggle
    (function() {
        const translationCheckboxes = document.querySelectorAll('.translation-checkbox');
        
        // Load saved preferences
        const savedPrefs = JSON.parse(localStorage.getItem('translationPrefs') || '{}');
        
        // Apply saved preferences
        translationCheckboxes.forEach(checkbox => {
            const translationType = checkbox.dataset.translation;
            if (savedPrefs[translationType] !== undefined) {
                checkbox.checked = savedPrefs[translationType];
            }
            updateTranslationVisibility(translationType, checkbox.checked);
        });
        
        // Handle checkbox changes
        translationCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const translationType = this.dataset.translation;
                const isChecked = this.checked;
                
                updateTranslationVisibility(translationType, isChecked);
                
                // Save preference
                savedPrefs[translationType] = isChecked;
                localStorage.setItem('translationPrefs', JSON.stringify(savedPrefs));
            });
        });
        
        function updateTranslationVisibility(type, show) {
            const elements = document.querySelectorAll(`.translation-${type}`);
            elements.forEach(el => {
                el.style.display = show ? 'block' : 'none';
            });
        }
    })();
</script>