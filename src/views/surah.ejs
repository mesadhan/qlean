
<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="/quran" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Surah List</a>
    <% if (typeof activePage !== 'undefined' && activePage === 'surah') { %>
    <button class="btn btn-outline-success" id="settingsToggleMobile" title="Display Settings">
        <i class="bi bi-sliders"></i> Settings
    </button>
    <% } %>
</div>

<!-- Settings Sidebar Panel -->
<div id="settingsPanel" class="settings-panel">
    <div class="settings-header">
        <h5 class="mb-0"><i class="bi bi-sliders"></i> Display Settings</h5>
        <button class="btn-close settings-close" id="settingsPanelClose" aria-label="Close settings"></button>
    </div>
    
    <div class="settings-body">
        <!-- Quran Font Selection -->
        <div class="settings-section">
            <label class="settings-label"><i class="bi bi-type"></i> Quran Font</label>
            <div class="font-options">
                <div class="form-check">
                    <input class="form-check-input quran-font-radio" type="radio" name="quranFont" id="fontTraditional" value="traditional" checked>
                    <label class="form-check-label" for="fontTraditional">
                        <span class="font-preview" style="font-family: 'Traditional Arabic', serif;">ŸÇ</span>
                        Traditional
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input quran-font-radio" type="radio" name="quranFont" id="fontUthmani" value="uthmani">
                    <label class="form-check-label" for="fontUthmani">
                        <span class="font-preview" style="font-family: 'Scheherazade New', serif;">ŸÇ</span>
                        Uthmani
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input quran-font-radio" type="radio" name="quranFont" id="fontIndoPak" value="indopak">
                    <label class="form-check-label" for="fontIndoPak">
                        <span class="font-preview" style="font-family: 'IndoPak', serif;">ŸÇ</span>
                        IndoPak
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input quran-font-radio" type="radio" name="quranFont" id="fontTajweed" value="tajweed">
                    <label class="form-check-label" for="fontTajweed">
                        <span class="font-preview" style="font-family: 'Tajweed', serif;">ŸÇ</span>
                        Tajweed
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Arabic Text Size -->
        <div class="settings-section">
            <label class="settings-label"><i class="bi bi-aspect-ratio"></i> Arabic Text Size</label>
            <div class="size-control">
                <button class="btn-size" id="decreaseSize" title="Decrease size">
                    <i class="bi bi-dash-circle"></i>
                </button>
                <span class="size-display" id="sizeDisplay">100%</span>
                <button class="btn-size" id="increaseSize" title="Increase size">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
            <div class="size-preset-buttons">
                <button class="size-preset" data-size="80">Small</button>
                <button class="size-preset active" data-size="100">Normal</button>
                <button class="size-preset" data-size="120">Large</button>
                <button class="size-preset" data-size="150">Huge</button>
            </div>
        </div>
        
        <!-- Translation Display -->
        <div class="settings-section" style="display: none;">
            <label class="settings-label"><i class="bi bi-eye"></i> Translation Display</label>
            <div class="translation-display-options">
                <div class="form-check">
                    <input class="form-check-input translation-display-radio" type="radio" name="translationDisplay" id="displayBoth" value="both" checked>
                    <label class="form-check-label" for="displayBoth">Show Both</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input translation-display-radio" type="radio" name="translationDisplay" id="displayBengali" value="bengali">
                    <label class="form-check-label" for="displayBengali">Bengali Only</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input translation-display-radio" type="radio" name="translationDisplay" id="displayEnglish" value="english">
                    <label class="form-check-label" for="displayEnglish">English Only</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input translation-display-radio" type="radio" name="translationDisplay" id="displayArabicOnly" value="arabic">
                    <label class="form-check-label" for="displayArabicOnly">Arabic Only</label>
                </div>
            </div>
        </div>
        
        <!-- Translation Selection (Moved from main card) -->
        <div class="settings-section">
            <label class="settings-label"><i class="bi bi-translate"></i> Select Translations</label>
            <div class="translation-select-options">
                <div class="translation-language-group">
                    <h6 class="mb-2 small fw-bold text-success">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</h6>
                    <% config.translationsByLanguage.bangla.forEach((t) => { %>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="settings_bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               data-order="<%= t.order %>"
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="settings_bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
                <div class="translation-language-group mt-2">
                    <h6 class="mb-2 small fw-bold text-primary">English Translation</h6>
                    <% config.translationsByLanguage.english.forEach((t) => { %>
                    <div class="form-check form-check-sm">
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="settings_english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               data-order="<%= t.order %>"
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="settings_english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
            </div>
        </div>
        
        <!-- Reset Button -->
        <div class="settings-section">
            <button class="btn btn-outline-danger w-100" id="resetSettings">
                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
            </button>
        </div>
    </div>
</div>

<!-- Settings Panel Overlay -->
<div id="settingsPanelOverlay" class="settings-overlay"></div>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0 arabic-text"><%= surah.name %></h3>
                <h5 class="mb-0"><%= surah.transliteration %> - <%= surah.translation %></h5>
            </div>
            <span class="badge bg-light text-dark"><%= surah.totalAyahs %> Ayahs</span>
        </div>
    </div>
    
    <!-- Translation Selection -->
    <div class="card-body border-bottom">
        <div class="row g-3 border-bottom" style="display: none;">
            <!-- Bengali Translations -->
            <div class="col-md-6">
                <h6 class="mb-2"><i class="bi bi-translate text-success me-1"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</h6>
                <div class="d-flex flex-wrap gap-2">
                    <% config.translationsByLanguage.bangla.forEach((t, index) => { %>
                    <div class="form-check d-flex align-items-center gap-1">
                        <!-- <select class="form-select form-select-sm translation-order-select" 
                                data-translation="<%= t.id %>" 
                                data-language="bangla"
                                style="width: 50px; padding: 2px 4px; font-size: 0.75rem;">
                            <% for(let i = 1; i <= config.translationsByLanguage.bangla.length; i++) { %>
                            <option value="<%= i %>" <%= t.order === i ? 'selected' : '' %>><%= i %></option>
                            <% } %>
                        </select> -->
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               data-order="<%= t.order %>"
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="bangla<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
            </div>
            <!-- English Translations -->
            <div class="col-md-6">
                <h6 class="mb-2"><i class="bi bi-translate text-primary me-1"></i> English Translation</h6>
                <div class="d-flex flex-wrap gap-2">
                    <% config.translationsByLanguage.english.forEach((t, index) => { %>
                    <div class="form-check d-flex align-items-center gap-1">
                        <!-- <select class="form-select form-select-sm translation-order-select" 
                                data-translation="<%= t.id %>" 
                                data-language="english"
                                style="width: 50px; padding: 2px 4px; font-size: 0.75rem;">
                            <% for(let i = 1; i <= config.translationsByLanguage.english.length; i++) { %>
                            <option value="<%= i %>" <%= t.order === i ? 'selected' : '' %>><%= i %></option>
                            <% } %>
                        </select> -->
                        <input class="form-check-input translation-checkbox" type="checkbox" 
                               id="english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>" 
                               data-translation="<%= t.id %>" 
                               data-order="<%= t.order %>"
                               <%= t.isDefault ? 'checked' : '' %>>
                        <label class="form-check-label small" for="english<%= t.id.charAt(0).toUpperCase() + t.id.slice(1) %>"><%= t.label %></label>
                    </div>
                    <% }) %>
                </div>
            </div>
        </div>
        
        <!-- Word-by-Word Toggle -->
        <div class="mt-3 p-3">
            <div class="form-check form-switch word-by-word-toggle">
                <input class="form-check-input" type="checkbox" role="switch" id="wordByWordToggle" checked>
                <label class="form-check-label" for="wordByWordToggle">
                    <i class="bi bi-cursor-text me-1"></i> 
                    ‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶Ö‡¶∞‡ßç‡¶• (Word-by-Word) 
                    <small class="text-muted">- ‡¶°‡¶æ‡¶¨‡¶≤ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡ßá ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®</small>
                </label>
            </div>
        </div>
    </div>
    
    <!-- Audio Player Section -->
    <div class="card-body">
        <div class="d-flex flex-column gap-3">
            
           <div style="display: none;">
                <!-- Arabic Reciter Selection -->
                <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="arabicReciterSection" data-language="arabic" style="display: none;">
                    <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ï‡¶æ‡¶∞‡ßÄ:</label>
                    <% if (config.audio.reciters.arabic.length > 1) { %>
                    <select class="form-select form-select-sm reciter-select" id="arabicReciterSelect" data-language="arabic" style="max-width: 280px;">
                        <% config.audio.reciters.arabic.forEach(r => { %>
                        <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                        <% }) %>
                    </select>
                    <% } else { %>
                    <span class="badge bg-success"><%= config.audio.reciters.arabic[0].name %></span>
                    <% } %>
                </div>
                
                <!-- Urdu Reciter Selection -->
                <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="urduReciterSection" data-language="urdu" style="display: none;">
                    <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶â‡¶∞‡ßç‡¶¶‡ßÅ ‡¶ï‡¶æ‡¶∞‡ßÄ:</label>
                    <% if (config.audio.reciters.urdu.length > 1) { %>
                    <select class="form-select form-select-sm reciter-select" id="urduReciterSelect" data-language="urdu" style="max-width: 280px;">
                        <% config.audio.reciters.urdu.forEach(r => { %>
                        <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                        <% }) %>
                    </select>
                    <% } else { %>
                    <span class="badge bg-success"><%= config.audio.reciters.urdu[0].name %></span>
                    <% } %>
                </div>
                
                <!-- English Reciter Selection -->
                <div class="d-flex align-items-center gap-2 flex-wrap reciter-section" id="englishReciterSection" data-language="english" style="display: none;">
                    <label class="form-label mb-0"><i class="bi bi-person-circle"></i> English Reciter:</label>
                    <% if (config.audio.reciters.english.length > 1) { %>
                    <select class="form-select form-select-sm reciter-select" id="englishReciterSelect" data-language="english" style="max-width: 280px;">
                        <% config.audio.reciters.english.forEach(r => { %>
                        <option value="<%= r.id %>" <%= r.isDefault ? 'selected' : '' %>><%= r.name %></option>
                        <% }) %>
                    </select>
                    <% } else { %>
                    <span class="badge bg-primary"><%= config.audio.reciters.english[0].name %></span>
                    <% } %>
                </div>

                <!-- Audio Type Selection -->
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <label class="form-label mb-0"><i class="bi bi-translate"></i> Audio Type:</label>
                    <div class="btn-group" role="group">
                        <% config.audio.types.forEach((type, index) => { %>
                        <input type="radio" class="btn-check" name="audioType" id="audio<%= type.id.charAt(0).toUpperCase() + type.id.slice(1) %>" value="<%= type.id %>" <%= index === 0 ? 'checked' : '' %>>
                        <label class="btn btn-outline-success btn-sm" for="audio<%= type.id.charAt(0).toUpperCase() + type.id.slice(1) %>"><%= type.labelBn ? type.labelBn + ' (' + type.label + ')' : type.label %></label>
                        <% }) %>
                    </div>
                </div>
                
                
                <!-- Full Surah Player -->
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button class="btn btn-success" id="playSurahBtn">
                        <i class="bi bi-play-fill"></i> Play Full Surah
                    </button>
                    <button class="btn btn-outline-secondary" id="stopSurahBtn" style="display: none;">
                        <i class="bi bi-stop-fill"></i> Stop
                    </button>
                    <span id="nowPlaying" class="text-muted small"></span>
                </div>
            </div>
            
            <!-- Audio Element for Full Surah -->
            <audio id="surahAudio" class="w-100" controls style="display: none;"></audio>
        </div>
    </div>
</div>

<!-- Pagination Controls (Top) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-between align-items-center mb-3 pagination-controls flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0 small">‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§/‡¶™‡ßá‡¶ú:</label>
        <select class="form-select form-select-sm" id="ayahsPerPage" style="width: auto;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">‡¶∏‡¶¨</option>
        </select>
    </div>
    <span class="text-muted small" id="pageInfo"></span>
    <nav aria-label="Ayah pagination">
        <ul class="pagination pagination-sm mb-0" id="paginationTop"></ul>
    </nav>
</div>
<% } %>

<!-- Ayahs Container -->
<div id="ayahsContainer">
<!-- Ayahs with individual play buttons -->
<% if (surah.ayahs && surah.ayahs.length > 0) { %>
    <% surah.ayahs.forEach(ayah => { %>
        <div class="card ayah-card ayah-item" id="ayah-<%= ayah.number %>" data-ayah-number="<%= ayah.number %>">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success"><%= ayah.number %></span>
                        <button class="btn btn-sm btn-outline-success play-ayah-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                title="Play this Ayah">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-1">
                        <% const defaultTranslation = config.translations.find(t => t.isDefault && t.language === 'bangla') || config.translations[0]; %>
                        <button class="btn btn-sm btn-outline-primary share-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-surah-name="<%= surah.transliteration %>"
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translations[defaultTranslation.id] || '' %>"
                                title="Share this Ayah">
                            <i class="bi bi-share"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning bookmark-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translations[defaultTranslation.id] || '' %>"
                                title="Bookmark this Ayah">
                            <i class="bi bi-bookmark"></i>
                        </button>
                    </div>
                </div>
                <p class="arabic-text" id="arabic-<%= ayah.number %>"><%= ayah.text %></p>
                
                <!-- Dynamic Translations Container -->
                <div class="translations-container" data-ayah="<%= ayah.number %>">
                <% config.translations.forEach((t, index) => { %>
                <% if (ayah.translations[t.id]) { %>
                <div class="translation-<%= t.id %> <%= t.language %>-translation translation-item" 
                     data-translation-id="<%= t.id %>"
                     data-language="<%= t.language %>"
                     data-order="<%= t.order %>"
                     style="<%= t.isDefault ? '' : 'display: none;' %>">
                    <p class="translation-text <%= t.language === 'english' ? 'text-muted' : '' %> mb-2">
                        <span class="badge <%= t.language === 'bangla' ? 'bg-success' : 'bg-secondary' %> me-1">
                            <%= t.language === 'bangla' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English' %>
                        </span>
                        <small class="<%= t.language === 'english' ? '' : 'text-muted' %> fw-semibold"><%= t.label %>:</small>
                        <br><%= ayah.translations[t.id] %>
                    </p>
                </div>
                <% } %>
                <% }) %>
                </div>
            </div>
        </div>
    <% }) %>
<% } else { %>
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        Could not load ayahs. Please try refreshing the page or check your internet connection.
    </div>
<% } %>
</div>

<!-- Pagination Controls (Bottom) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-center mt-3">
    <nav aria-label="Ayah pagination bottom">
        <ul class="pagination" id="paginationBottom"></ul>
    </nav>
</div>
<% } %>

<!-- Hidden audio element for ayah playback -->
<audio id="ayahAudio"></audio>

<!-- Fixed Bottom Audio Player Control Bar -->
<div id="audioPlayerBar" class="audio-player-bar">
    <div class="player-container">
        <!-- Progress Bar -->
        <div class="progress-section">
            <span class="time-display" id="currentTime">0:00</span>
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
            </div>
            <span class="time-display" id="totalTime">0:00</span>
        </div>
        
        <!-- Main Controls -->
        <div class="controls-section">
            <!-- Left Controls -->
            <div class="controls-left">
                <div class="speed-dropdown">
                    <select class="speed-select" id="speedSelect" title="Playback Speed">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <button class="player-btn" id="repeatBtn" title="Repeat Mode">
                    <i class="bi bi-repeat"></i>
                </button>
            </div>
            
            <!-- Center Controls -->
            <div class="controls-center">
                <button class="player-btn nav-btn" id="prevAyahBtn" title="Previous Ayah">
                    <i class="bi bi-skip-backward-fill"></i>
                </button>
                <button class="player-btn play-pause-btn" id="mainPlayPauseBtn" title="Play/Pause">
                    <i class="bi bi-play-fill" id="playPauseIcon"></i>
                </button>
                <button class="player-btn nav-btn" id="nextAyahBtn" title="Next Ayah">
                    <i class="bi bi-skip-forward-fill"></i>
                </button>
            </div>
            
            <!-- Right Controls -->
            <div class="controls-right">
                <div class="volume-control">
                    <button class="player-btn volume-btn" id="volumeBtn" title="Volume">
                        <i class="bi bi-volume-up-fill" id="volumeIcon"></i>
                    </button>
                    <div class="volume-slider-container" id="volumeSliderContainer">
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
                    </div>
                </div>
                <button class="player-btn" id="autoPlayToggle" title="Auto-play next ayah">
                    <i class="bi bi-collection-play"></i>
                </button>
            </div>
        </div>
        
        <!-- Now Playing Info -->
        <div class="now-playing-section">
            <div class="now-playing-info">
                <span class="surah-name"><%= surah.transliteration %></span>
                <span class="ayah-indicator" id="playerAyahIndicator">Select an ayah to play</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // DYNAMIC CONFIGURATION (from server)
    // ============================================
    const APP_CONFIG = <%- JSON.stringify(config) %>;
    
    // Surah ayah counts from server config (derived from SURAH_METADATA)
    const SURAH_AYAH_COUNTS = APP_CONFIG.surahAyahCounts;
    
    const surahId = <%= surah.id %>;
    const totalAyahs = <%= surah.totalAyahs %>;
    
    // Calculate global ayah number
    function getGlobalAyahNumber(surahId, ayahNumber) {
        let globalNumber = 0;
        for (let i = 0; i < surahId - 1; i++) {
            globalNumber += SURAH_AYAH_COUNTS[i];
        }
        return globalNumber + ayahNumber;
    }
    
    // Get Arabic ayah audio URL (everyayah.com - reliable source)
    function getArabicAyahAudioUrl(surahId, ayahNumber, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        return `https://everyayah.com/data/${reciterFolder}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get Urdu translation audio URL (uses reciter ID from config)
    function getUrduAyahAudioUrl(surahId, ayahNumber, reciterId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Use the reciter ID directly (it's the folder name)
        return `https://everyayah.com/data/translations/${reciterId}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get English translation audio URL (uses reciter ID from config)
    function getEnglishAyahAudioUrl(surahId, ayahNumber, reciterId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Use the reciter ID directly (it's the folder path like 'English/Sahih_Intnl_Ibrahim_Walk_192kbps')
        return `https://everyayah.com/data/${reciterId}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get full surah audio URL (quranicaudio.com)
    function getSurahAudioUrl(surahId, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        return `https://download.quranicaudio.com/quran/${reciterFolder}/${paddedSurah}.mp3`;
    }
    
    // ============================================
    // DYNAMIC AUDIO HELPERS
    // ============================================
    
    // Get default reciter ID for a language
    function getDefaultReciter(language) {
        const reciters = APP_CONFIG.audio.reciters[language];
        if (!reciters || reciters.length === 0) return null;
        const defaultReciter = reciters.find(r => r.isDefault);
        return defaultReciter ? defaultReciter.id : reciters[0].id;
    }
    
    // Get selected reciter for a language (from dropdown or default)
    function getSelectedReciter(language) {
        const select = document.getElementById(`${language}ReciterSelect`);
        if (select) {
            return select.value;
        }
        return getDefaultReciter(language);
    }
    
    // Audio elements
    const surahAudio = document.getElementById('surahAudio');
    const ayahAudio = document.getElementById('ayahAudio');
    const playSurahBtn = document.getElementById('playSurahBtn');
    const stopSurahBtn = document.getElementById('stopSurahBtn');
    const nowPlaying = document.getElementById('nowPlaying');
    
    // Dynamic reciter sections
    const reciterSections = {};
    APP_CONFIG.audio.types.forEach(type => {
        type.showsReciters.forEach(lang => {
            if (!reciterSections[lang]) {
                reciterSections[lang] = document.getElementById(`${lang}ReciterSection`);
            }
        });
    });
    
    // Audio type radio buttons
    const audioTypeRadios = document.querySelectorAll('input[name="audioType"]');
    
    let currentlyPlayingAyah = null;
    let isPlayingSequence = false;
    let currentAudioType = 'arabic';
    let isPlayingTranslationAfterArabic = false;
    
    // Hidden audio element for translation playback in "Both" mode
    const translationAudio = document.createElement('audio');
    translationAudio.id = 'translationAudio';
    document.body.appendChild(translationAudio);
    
    // Get current audio type
    function getAudioType() {
        const selected = document.querySelector('input[name="audioType"]:checked');
        return selected ? selected.value : 'arabic';
    }
    
    // Get translation language for "both" mode
    function getTranslationLanguage() {
        return localStorage.getItem('translationLanguage') || 'english';
    }
    
    // Function to update reciter section visibility based on audio type (DYNAMIC)
    function updateReciterSectionVisibility(audioType) {
        // Hide all reciter sections first
        Object.values(reciterSections).forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // Find the audio type config
        const audioTypeConfig = APP_CONFIG.audio.types.find(t => t.id === audioType);
        if (!audioTypeConfig) return;
        
        // Show the relevant sections
        audioTypeConfig.showsReciters.forEach(lang => {
            const section = reciterSections[lang];
            if (section) section.style.display = 'flex';
        });
    }
    
    // Handle audio type change
    audioTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            currentAudioType = getAudioType();
            updateReciterSectionVisibility(currentAudioType);
            localStorage.setItem('audioType', currentAudioType);
        });
    });
    
    // Initialize: Load saved audio type and update visibility
    const savedAudioType = localStorage.getItem('audioType') || 'arabic';
    const savedRadio = document.querySelector(`input[name="audioType"][value="${savedAudioType}"]`);
    if (savedRadio) {
        savedRadio.checked = true;
    }
    currentAudioType = savedAudioType;
    // Call visibility update after a small delay to ensure DOM is ready
    setTimeout(() => {
        updateReciterSectionVisibility(savedAudioType);
    }, 0);
    
    // Load saved reciter preferences for all languages dynamically
    Object.keys(APP_CONFIG.audio.reciters).forEach(language => {
        const savedKey = `preferredReciter_${language}`;
        const savedReciter = localStorage.getItem(savedKey);
        const select = document.getElementById(`${language}ReciterSelect`);
        
        if (select && savedReciter) {
            select.value = savedReciter;
        }
        
        // Save preference on change
        if (select) {
            select.addEventListener('change', () => {
                localStorage.setItem(savedKey, select.value);
            });
        }
    });
    
    // Migration: old 'preferredReciter' to new format
    const oldSavedReciter = localStorage.getItem('preferredReciter');
    if (oldSavedReciter) {
        const arabicSelect = document.getElementById('arabicReciterSelect');
        if (arabicSelect) {
            // Check if it's an old format value and migrate
            const oldToNewMap = {
                'ar.alafasy': 'Alafasy_128kbps',
                'ar.abdulbasitmurattal': 'Abdul_Basit_Murattal_192kbps',
                'ar.abdulsamad': 'Abdul_Basit_Mujawwad_128kbps',
                'ar.husary': 'Husary_128kbps',
                'ar.minshawi': 'Minshawy_Murattal_128kbps',
                'ar.ahmedajamy': 'Ahmed_ibn_Ali_al_Ajamy_128kbps_ketaballah.net',
                'ar.muhammadayyoub': 'Muhammad_Ayyoub_128kbps',
                'ar.muhammadjibreel': 'Muhammad_Jibreel_128kbps'
            };
            const newValue = oldToNewMap[oldSavedReciter] || oldSavedReciter;
            arabicSelect.value = newValue;
            localStorage.setItem('preferredReciter_arabic', newValue);
            localStorage.removeItem('preferredReciter'); // Clean up old key
        }
    }
    
    // Play full surah (Arabic only - translations play ayah by ayah)
    playSurahBtn.addEventListener('click', () => {
        const audioType = getAudioType();
        
        if (audioType === 'urdu' || audioType === 'english') {
            // For translations, play ayah by ayah starting from first
            const firstAyahBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstAyahBtn) {
                firstAyahBtn.click();
            }
            return;
        }
        
        const reciterId = getSelectedReciter('arabic') || getDefaultReciter('arabic');
        const audioUrl = getSurahAudioUrl(surahId, reciterId);
        
        surahAudio.src = audioUrl;
        surahAudio.style.display = 'block';
        surahAudio.play();
        
        playSurahBtn.style.display = 'none';
        stopSurahBtn.style.display = 'inline-block';
        nowPlaying.textContent = audioType === 'both' ? 'Playing full surah (Arabic)...' : 'Playing full surah...';
    });
    
    // Stop surah
    stopSurahBtn.addEventListener('click', () => {
        surahAudio.pause();
        surahAudio.currentTime = 0;
        surahAudio.style.display = 'none';
        
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // When surah audio ends
    surahAudio.addEventListener('ended', () => {
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // Play individual ayah
    document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const audioType = getAudioType();
            const arabicReciterId = getSelectedReciter('arabic') || getDefaultReciter('arabic');
            
            // Stop surah audio if playing
            surahAudio.pause();
            playSurahBtn.style.display = 'inline-block';
            stopSurahBtn.style.display = 'none';
            surahAudio.style.display = 'none';
            
            // Reset translation state
            isPlayingTranslationAfterArabic = false;
            translationAudio.pause();
            
            // Reset previous playing button and card highlight
            if (currentlyPlayingAyah) {
                const prevBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
                if (prevBtn) {
                    prevBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    prevBtn.classList.remove('btn-success', 'playing');
                    prevBtn.classList.add('btn-outline-success');
                }
                const prevCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
                if (prevCard) {
                    prevCard.classList.remove('playing', 'border-success');
                }
            }
            
            // If clicking same ayah, toggle
            if (currentlyPlayingAyah === ayahNumber && !ayahAudio.paused) {
                ayahAudio.pause();
                translationAudio.pause();
                btn.innerHTML = '<i class="bi bi-play-fill"></i>';
                btn.classList.remove('btn-success', 'playing');
                btn.classList.add('btn-outline-success');
                document.getElementById(`ayah-${ayahNumber}`).classList.remove('playing', 'border-success');
                currentlyPlayingAyah = null;
                nowPlaying.textContent = '';
                return;
            }
            
            // Determine which audio to play based on type (using dynamic config)
            let audioUrl;
            if (audioType === 'arabic' || audioType === 'both') {
                audioUrl = getArabicAyahAudioUrl(surahId, ayahNumber, arabicReciterId);
            } else if (audioType === 'urdu') {
                const urduReciterId = getSelectedReciter('urdu') || getDefaultReciter('urdu');
                audioUrl = getUrduAyahAudioUrl(surahId, ayahNumber, urduReciterId);
            } else if (audioType === 'english') {
                const englishReciterId = getSelectedReciter('english') || getDefaultReciter('english');
                audioUrl = getEnglishAyahAudioUrl(surahId, ayahNumber, englishReciterId);
            }
            
            // Play the audio
            ayahAudio.src = audioUrl;
            ayahAudio.play().catch(err => console.error('Play error:', err));
            
            btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
            btn.classList.add('btn-success', 'playing');
            btn.classList.remove('btn-outline-success');
            currentlyPlayingAyah = ayahNumber;
            
            // Set status text based on audio type (dynamic)
            const audioTypeConfig = APP_CONFIG.audio.types.find(t => t.id === audioType);
            if (audioType === 'both') {
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶§‡ßá‡¶≤‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶§`;
            } else if (audioTypeConfig) {
                const label = audioTypeConfig.labelBn || audioTypeConfig.label;
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ${label}`;
            } else {
                nowPlaying.textContent = `Playing Ayah ${ayahNumber}`;
            }
            
            // Highlight current ayah with playing animation
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
            const currentCard = document.getElementById(`ayah-${ayahNumber}`);
            currentCard.classList.add('playing');
            currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });
    
    // When ayah audio ends - handled by bottom player bar code
    // (See the comprehensive handler in the Bottom Audio Player Bar Controls section)
    
    // When translation audio ends (for "Both" mode) - handled by bottom player bar code
    // (See the comprehensive handler in the Bottom Audio Player Bar Controls section)
    
    // Bookmark functionality
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    
    // Update bookmark button icons on load
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        const surahId = parseInt(btn.dataset.surahId);
        const ayahNumber = parseInt(btn.dataset.ayahNumber);
        const isBookmarked = bookmarks.some(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
        if (isBookmarked) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
        }
    });
    
    // Handle bookmark toggle
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const surahId = parseInt(btn.dataset.surahId);
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const text = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            const index = bookmarks.findIndex(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
            
            if (index > -1) {
                bookmarks.splice(index, 1);
                btn.innerHTML = '<i class="bi bi-bookmark"></i>';
            } else {
                bookmarks.push({ surahId, ayahNumber, text, translation });
                btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        });
    });
    
    // Share functionality
    function showShareToast(message) {
        const toast = document.createElement('div');
        toast.className = 'share-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const surahId = btn.dataset.surahId;
            const surahName = btn.dataset.surahName;
            const ayahNumber = btn.dataset.ayahNumber;
            const arabicText = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            // Get current page from URL
            const params = new URLSearchParams(window.location.search);
            const currentPage = params.get('page');
            
            // Build URL with page parameter if present
            let shareUrl = `${window.location.origin}/surah/${surahId}`;
            if (currentPage && currentPage !== '1') {
                shareUrl += `?page=${currentPage}`;
            }
            shareUrl += `#ayah-${ayahNumber}`;
            
            const shareText = `üìñ ‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}\n\n${arabicText}\n\n${translation}\n\nüîó ${shareUrl}`;
            
            // Always copy to clipboard first
            await copyToClipboard(shareText, shareUrl);
            
            // Then try Web Share API (mobile-friendly)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}`,
                        text: shareText,
                        url: shareUrl
                    });
                } catch (err) {
                    // User cancelled or error - clipboard already copied
                }
            }
        });
    });
    
    async function copyToClipboard(text, url) {
        console.log('Copying to clipboard:', url);
        try {
            await navigator.clipboard.writeText(url);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        } catch {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = url;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        }
    }
    
    // =========================================
    // Bottom Audio Player Bar Controls
    // =========================================
    const playerBar = document.getElementById('audioPlayerBar');
    const mainPlayPauseBtn = document.getElementById('mainPlayPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const prevAyahBtn = document.getElementById('prevAyahBtn');
    const nextAyahBtn = document.getElementById('nextAyahBtn');
    const speedSelect = document.getElementById('speedSelect');
    const repeatBtn = document.getElementById('repeatBtn');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const autoPlayToggle = document.getElementById('autoPlayToggle');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBarFill = document.getElementById('progressBarFill');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const playerAyahIndicator = document.getElementById('playerAyahIndicator');
    
    // Player state
    let isAutoPlayEnabled = true;
    let repeatMode = 'none'; // 'none', 'one', 'all'
    let playbackSpeed = 1;
    
    // Load saved preferences
    const savedAutoPlay = localStorage.getItem('autoPlayEnabled');
    if (savedAutoPlay !== null) {
        isAutoPlayEnabled = savedAutoPlay === 'true';
    }
    autoPlayToggle.classList.toggle('active', isAutoPlayEnabled);
    
    const savedRepeat = localStorage.getItem('repeatMode');
    if (savedRepeat) {
        repeatMode = savedRepeat;
        updateRepeatButton();
    }
    
    const savedVolume = localStorage.getItem('playerVolume');
    if (savedVolume) {
        volumeSlider.value = savedVolume;
        ayahAudio.volume = savedVolume / 100;
        translationAudio.volume = savedVolume / 100;
        updateVolumeIcon(savedVolume);
    }
    
    const savedSpeed = localStorage.getItem('playbackSpeed');
    if (savedSpeed) {
        playbackSpeed = parseFloat(savedSpeed);
        speedSelect.value = savedSpeed;
        ayahAudio.playbackRate = playbackSpeed;
        translationAudio.playbackRate = playbackSpeed;
    }
    
    // Show player bar when there's an ayah to play
    function showPlayerBar() {
        playerBar.classList.add('active');
    }
    
    function hidePlayerBar() {
        playerBar.classList.remove('active');
    }
    
    // Format time (seconds to mm:ss)
    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update progress bar
    ayahAudio.addEventListener('timeupdate', () => {
        if (ayahAudio.duration) {
            const progress = (ayahAudio.currentTime / ayahAudio.duration) * 100;
            progressBarFill.style.width = progress + '%';
            currentTimeDisplay.textContent = formatTime(ayahAudio.currentTime);
        }
    });
    
    ayahAudio.addEventListener('loadedmetadata', () => {
        totalTimeDisplay.textContent = formatTime(ayahAudio.duration);
    });
    
    ayahAudio.addEventListener('play', () => {
        playPauseIcon.className = 'bi bi-pause-fill';
        mainPlayPauseBtn.classList.add('playing');
        showPlayerBar();
    });
    
    ayahAudio.addEventListener('pause', () => {
        if (!isPlayingTranslationAfterArabic) {
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
        }
    });
    
    // Translation audio events for "Both" mode
    translationAudio.addEventListener('play', () => {
        playPauseIcon.className = 'bi bi-pause-fill';
        mainPlayPauseBtn.classList.add('playing');
    });
    
    translationAudio.addEventListener('timeupdate', () => {
        if (isPlayingTranslationAfterArabic && translationAudio.duration) {
            const progress = (translationAudio.currentTime / translationAudio.duration) * 100;
            progressBarFill.style.width = progress + '%';
            currentTimeDisplay.textContent = formatTime(translationAudio.currentTime);
            totalTimeDisplay.textContent = formatTime(translationAudio.duration);
        }
    });
    
    // Click on progress bar to seek
    progressBarContainer.addEventListener('click', (e) => {
        const rect = progressBarContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        const percent = clickX / width;
        
        if (isPlayingTranslationAfterArabic) {
            translationAudio.currentTime = percent * translationAudio.duration;
        } else if (ayahAudio.duration) {
            ayahAudio.currentTime = percent * ayahAudio.duration;
        }
    });
    
    // Main play/pause button
    mainPlayPauseBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah) {
            if (isPlayingTranslationAfterArabic) {
                if (translationAudio.paused) {
                    translationAudio.play();
                } else {
                    translationAudio.pause();
                }
            } else {
                if (ayahAudio.paused) {
                    ayahAudio.play();
                } else {
                    ayahAudio.pause();
                }
            }
        } else {
            // Start playing from first ayah
            const firstAyahBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstAyahBtn) {
                firstAyahBtn.click();
            }
        }
    });
    
    // Previous ayah button
    prevAyahBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah && currentlyPlayingAyah > 1) {
            // Stop current playback
            ayahAudio.pause();
            translationAudio.pause();
            isPlayingTranslationAfterArabic = false;
            
            const prevAyah = currentlyPlayingAyah - 1;
            const prevBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${prevAyah}"]`);
            if (prevBtn) {
                prevBtn.click();
            }
        }
    });
    
    // Next ayah button
    nextAyahBtn.addEventListener('click', () => {
        if (currentlyPlayingAyah && currentlyPlayingAyah < totalAyahs) {
            // Stop current playback
            ayahAudio.pause();
            translationAudio.pause();
            isPlayingTranslationAfterArabic = false;
            
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                nextBtn.click();
            }
        }
    });
    
    // Speed control dropdown
    speedSelect.addEventListener('change', () => {
        playbackSpeed = parseFloat(speedSelect.value);
        ayahAudio.playbackRate = playbackSpeed;
        translationAudio.playbackRate = playbackSpeed;
        localStorage.setItem('playbackSpeed', playbackSpeed);
    });
    
    // Repeat mode toggle
    function updateRepeatButton() {
        if (repeatMode === 'none') {
            repeatBtn.classList.remove('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat"></i>';
        } else if (repeatMode === 'one') {
            repeatBtn.classList.add('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat-1"></i>';
        } else {
            repeatBtn.classList.add('active');
            repeatBtn.innerHTML = '<i class="bi bi-repeat"></i>';
        }
    }
    
    repeatBtn.addEventListener('click', () => {
        if (repeatMode === 'none') {
            repeatMode = 'one';
        } else if (repeatMode === 'one') {
            repeatMode = 'all';
        } else {
            repeatMode = 'none';
        }
        updateRepeatButton();
        localStorage.setItem('repeatMode', repeatMode);
    });
    
    // Volume control
    function updateVolumeIcon(value) {
        if (value == 0) {
            volumeIcon.className = 'bi bi-volume-mute-fill';
        } else if (value < 50) {
            volumeIcon.className = 'bi bi-volume-down-fill';
        } else {
            volumeIcon.className = 'bi bi-volume-up-fill';
        }
    }
    
    volumeSlider.addEventListener('input', () => {
        const value = volumeSlider.value;
        ayahAudio.volume = value / 100;
        translationAudio.volume = value / 100;
        surahAudio.volume = value / 100;
        updateVolumeIcon(value);
        localStorage.setItem('playerVolume', value);
    });
    
    let previousVolume = 100;
    volumeBtn.addEventListener('click', () => {
        if (volumeSlider.value > 0) {
            previousVolume = volumeSlider.value;
            volumeSlider.value = 0;
        } else {
            volumeSlider.value = previousVolume;
        }
        volumeSlider.dispatchEvent(new Event('input'));
    });
    
    // Auto-play toggle
    autoPlayToggle.addEventListener('click', () => {
        isAutoPlayEnabled = !isAutoPlayEnabled;
        autoPlayToggle.classList.toggle('active', isAutoPlayEnabled);
        localStorage.setItem('autoPlayEnabled', isAutoPlayEnabled);
    });
    
    // Update player bar ayah indicator when playing
    function updatePlayerBarInfo(ayahNumber) {
        if (ayahNumber) {
            const audioType = getAudioType();
            let audioTypeText = '‡¶Ü‡¶∞‡¶¨‡¶ø';
            if (audioType === 'urdu') audioTypeText = '‡¶â‡¶∞‡ßç‡¶¶‡ßÅ';
            else if (audioType === 'english') audioTypeText = 'English';
            else if (audioType === 'both') audioTypeText = 'Arabic + Translation';
            
            playerAyahIndicator.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} ‚Ä¢ ${audioTypeText}`;
        } else {
            playerAyahIndicator.textContent = 'Select an ayah to play';
        }
    }
    
    // Override existing ayah button click to update player bar
    const originalPlayHandler = (btn) => {
        btn.addEventListener('click', () => {
            showPlayerBar();
            updatePlayerBarInfo(parseInt(btn.dataset.ayahNumber));
        });
    };
    
    document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        originalPlayHandler(btn);
    });
    
    // Update the ayahAudio ended handler to use autoplay setting and repeat mode
    ayahAudio.removeEventListener('ended', () => {});
    ayahAudio.addEventListener('ended', () => {
        const audioType = getAudioType();
        
        // If in "both" mode and Arabic just finished, play English translation
        if (audioType === 'both' && !isPlayingTranslationAfterArabic) {
            isPlayingTranslationAfterArabic = true;
            const englishReciterId = getSelectedReciter('english') || getDefaultReciter('english');
            const translationUrl = getEnglishAyahAudioUrl(surahId, currentlyPlayingAyah, englishReciterId);
            translationAudio.src = translationUrl;
            translationAudio.playbackRate = playbackSpeed;
            translationAudio.play();
            nowPlaying.textContent = `Ayah ${currentlyPlayingAyah} - English Translation`;
            updatePlayerBarInfo(currentlyPlayingAyah);
            return;
        }
        
        // Check repeat mode
        if (repeatMode === 'one') {
            ayahAudio.currentTime = 0;
            ayahAudio.play();
            return;
        }
        
        // Reset translation state
        isPlayingTranslationAfterArabic = false;
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah if enabled
        if (isAutoPlayEnabled && currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else if (repeatMode === 'all' && currentlyPlayingAyah >= totalAyahs) {
            // Loop back to first ayah
            const firstBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstBtn) {
                document.getElementById('ayah-1').scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
            updatePlayerBarInfo(null);
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // Update translation audio ended handler
    translationAudio.removeEventListener('ended', () => {});
    translationAudio.addEventListener('ended', () => {
        isPlayingTranslationAfterArabic = false;
        
        // Check repeat mode for "both" audio type
        if (repeatMode === 'one') {
            // Restart from Arabic
            const currentBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
            if (currentBtn) {
                setTimeout(() => currentBtn.click(), 200);
            }
            return;
        }
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah if enabled
        if (isAutoPlayEnabled && currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else if (repeatMode === 'all' && currentlyPlayingAyah >= totalAyahs) {
            // Loop back to first ayah
            const firstBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstBtn) {
                document.getElementById('ayah-1').scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => firstBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            playPauseIcon.className = 'bi bi-play-fill';
            mainPlayPauseBtn.classList.remove('playing');
            updatePlayerBarInfo(null);
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // Keyboard shortcuts for player
    document.addEventListener('keydown', (e) => {
        // Don't trigger if typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }
        
        switch(e.code) {
            case 'Space':
                e.preventDefault();
                mainPlayPauseBtn.click();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                prevAyahBtn.click();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextAyahBtn.click();
                break;
            case 'ArrowUp':
                e.preventDefault();
                volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
                volumeSlider.dispatchEvent(new Event('input'));
                break;
            case 'ArrowDown':
                e.preventDefault();
                volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
                volumeSlider.dispatchEvent(new Event('input'));
                break;
            case 'KeyR':
                repeatBtn.click();
                break;
        }
    });
</script>

<style>
    /* Translation checkbox styling */
    .form-check {
        padding-left: 1.75em;
    }
    
    .translation-checkbox:checked {
        background-color: #198754;
        border-color: #198754;
    }
    
    /* Translation order select styling */
    .translation-order-select {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        min-width: 45px;
        text-align: center;
    }
    
    .translation-order-select:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        outline: none;
    }
    
    [data-bs-theme="dark"] .translation-order-select {
        background-color: #2c3034;
        border-color: #495057;
        color: #fff;
    }
    
    .translation-text small.fw-semibold {
        display: inline-block;
        margin-bottom: 0.25rem;
    }
    
    /* Dark mode for translation section */
    [data-bs-theme="dark"] .card-body h6 {
        color: #fff;
    }
    
    [data-bs-theme="dark"] .form-check-label {
        color: #e0e0e0;
    }
    
    /* Playing ayah card - enhanced highlight */
    .ayah-card.playing {
        border-left: 5px solid #871983 !important;
        /* background: linear-gradient(90deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.05) 50%, transparent 100%); */
        /* animation: pulse-highlight 2s ease-in-out infinite; */
        box-shadow: 0 0 20px rgba(25, 135, 84, 0.4);
        transform: scale(1.01);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Playing indicator bar */
    .ayah-card.playing::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 4px;
        /* background: linear-gradient(180deg, #198754, #20c997, #198754); */
        /* animation: gradient-flow 2s linear infinite; */
    }
    
    /* Sound wave indicator */
    .ayah-card.playing::after {
        /* content: 'üîä'; */
        content: '';
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
        /* animation: sound-wave 1s ease-in-out infinite; */
    }
    
    .ayah-card.playing .arabic-text {
        color: #146c43;
        font-weight: 600;
        /* animation: text-glow 2s ease-in-out infinite; */
    }
    
    [data-bs-theme="dark"] .ayah-card.playing {
        /* background: linear-gradient(90deg, rgba(25, 135, 84, 0.3) 0%, rgba(25, 135, 84, 0.15) 50%, rgba(25, 135, 84, 0.05) 100%); */
        box-shadow: 0 0 30px rgba(157, 243, 203, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.playing .arabic-text {
        color: #75b798;
    }
    
    @keyframes pulse-highlight {
        0%, 100% {
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.3);
        }
        50% {
            box-shadow: 0 0 30px rgba(25, 135, 84, 0.6);
        }
    }
    
    @keyframes gradient-flow {
        0% { background-position: 0% 0%; }
        100% { background-position: 0% 200%; }
    }
    
    @keyframes sound-wave {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    @keyframes text-glow {
        0%, 100% { text-shadow: 0 0 5px rgba(25, 135, 84, 0.3); }
        50% { text-shadow: 0 0 15px rgba(25, 135, 84, 0.6); }
    }
    
    .ayah-card.border-success {
        border-left-color: #198754 !important;
        border-width: 4px;
        background-color: rgba(25, 135, 84, 0.05);
    }
    
    [data-bs-theme="dark"] .ayah-card.border-success {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .ayah-item.hidden {
        display: none !important;
    }
    
    .pagination .page-link {
        cursor: pointer;
    }
    
    /* Now Playing button indicator */
    .play-ayah-btn.playing {
        animation: btn-pulse 1s ease-in-out infinite;
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: white !important;
    }
    
    @keyframes btn-pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
        }
    }
    
    /* Share button styles */
    .share-btn:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Toast notification */
    .share-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #198754;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: toast-slide-up 0.3s ease;
    }
    
    @keyframes toast-slide-up {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* Shared link highlight effect */
    .ayah-card.shared-highlight {
        border: 3px solid #0d6efd !important;
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.2) 0%, rgba(13, 110, 253, 0.1) 50%, rgba(13, 110, 253, 0.05) 100%);
        animation: shared-pulse 1.5s ease-in-out 3;
        box-shadow: 0 0 25px rgba(13, 110, 253, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.shared-highlight {
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.3) 0%, rgba(13, 110, 253, 0.15) 50%, rgba(13, 110, 253, 0.05) 100%);
        box-shadow: 0 0 35px rgba(13, 110, 253, 0.6);
    }
    
    @keyframes shared-pulse {
        0%, 100% {
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.4);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 35px rgba(13, 110, 253, 0.7);
            transform: scale(1.02);
        }
    }
    
    /* Fixed Bottom Audio Player Bar */
    .audio-player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border-top: 2px solid #198754;
        padding: 8px 16px;
        z-index: 1050;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .audio-player-bar.active {
        transform: translateY(0);
    }
    
    .player-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    /* Progress Section */
    .progress-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .time-display {
        font-size: 12px;
        color: #aaa;
        min-width: 40px;
        text-align: center;
        font-family: monospace;
    }
    
    .progress-bar-container {
        flex: 1;
        cursor: pointer;
        padding: 8px 0;
    }
    
    .progress-bar-bg {
        height: 6px;
        background: #333;
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #198754, #20c997);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
        position: relative;
    }
    
    .progress-bar-fill::after {
        content: '';
        position: absolute;
        right: -6px;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .progress-bar-container:hover .progress-bar-fill::after {
        opacity: 1;
    }
    
    /* Controls Section */
    .controls-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .controls-left,
    .controls-right {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
    }
    
    .controls-right {
        justify-content: flex-end;
    }
    
    .controls-center {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .player-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 18px;
    }
    
    .player-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
    }
    
    .player-btn:active {
        transform: scale(0.95);
    }
    
    .player-btn.active {
        color: #198754;
    }
    
    .play-pause-btn {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #198754, #20c997);
        border-radius: 50%;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4);
    }
    
    .play-pause-btn:hover {
        background: linear-gradient(135deg, #146c43, #198754);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.6);
    }
    
    .play-pause-btn.playing {
        animation: pulse-play 2s ease-in-out infinite;
    }
    
    @keyframes pulse-play {
        0%, 100% { box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4); }
        50% { box-shadow: 0 4px 25px rgba(25, 135, 84, 0.7); }
    }
    
    .nav-btn {
        font-size: 22px;
    }
    
    /* Speed Dropdown */
    .speed-dropdown {
        position: relative;
    }
    
    .speed-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        transition: all 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 28px;
        min-width: 70px;
    }
    
    .speed-select:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: #198754;
    }
    
    .speed-select:focus {
        border-color: #198754;
        box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.3);
    }
    
    .speed-select option {
        background: #1a1a2e;
        color: #fff;
        padding: 8px;
    }
    
    [data-bs-theme="light"] .speed-select {
        background-color: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.2);
        color: #333;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    }
    
    [data-bs-theme="light"] .speed-select option {
        background: #fff;
        color: #333;
    }
    
    /* Volume Control */
    .volume-control {
        display: flex;
        align-items: center;
        position: relative;
    }
    
    .volume-slider-container {
        width: 0;
        overflow: hidden;
        transition: width 0.3s ease;
    }
    
    .volume-control:hover .volume-slider-container {
        width: 80px;
        margin-left: 8px;
    }
    
    .volume-slider {
        width: 80px;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #333;
        border-radius: 2px;
        outline: none;
    }
    
    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #198754;
        border-radius: 50%;
        cursor: pointer;
    }
    
    .volume-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: #198754;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    
    /* Now Playing Section */
    .now-playing-section {
        text-align: center;
        padding: 4px 0;
    }
    
    .now-playing-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .surah-name {
        color: #198754;
        font-weight: 600;
        font-size: 13px;
    }
    
    .ayah-indicator {
        color: #aaa;
        font-size: 12px;
    }
    
    /* Add bottom padding to content when player is active */
    body:has(.audio-player-bar.active) {
        padding-bottom: 140px;
    }
    
    /* Light mode styles */
    [data-bs-theme="light"] .audio-player-bar {
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        border-top-color: #198754;
    }
    
    [data-bs-theme="light"] .player-btn {
        color: #333;
    }
    
    [data-bs-theme="light"] .time-display {
        color: #666;
    }
    
    [data-bs-theme="light"] .progress-bar-bg {
        background: #ccc;
    }
    
    [data-bs-theme="light"] .ayah-indicator {
        color: #666;
    }
    
    [data-bs-theme="light"] .volume-slider {
        background: #ccc;
    }
    
    /* Mobile responsive */
    @media (max-width: 576px) {
        .audio-player-bar {
            padding: 6px 10px;
        }
        
        .controls-left,
        .controls-right {
            min-width: auto;
            gap: 4px;
        }
        
        .player-btn {
            padding: 6px;
            font-size: 16px;
        }
        
        .play-pause-btn {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }
        
        .nav-btn {
            font-size: 18px;
        }
        
        .volume-control:hover .volume-slider-container {
            width: 60px;
        }
        
        .speed-select {
            min-width: 60px;
            padding: 4px 24px 4px 6px;
            font-size: 11px;
        }
        
        .now-playing-info {
            font-size: 11px;
        }
        
        body:has(.audio-player-bar.active) {
            padding-bottom: 120px;
        }
    }
    
    /* ============================================
       WORD-BY-WORD STYLES
       ============================================ */
    
    /* Word container */
    .arabic-text.word-by-word {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
        direction: rtl;
    }
    
    /* Individual word */
    .quran-word {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-width: auto;
    }
    
    .quran-word:hover {
        background: rgba(25, 135, 84, 0.1);
        transform: scale(1.05);
    }
    
    .quran-word:active {
        transform: scale(0.98);
    }
    
    .quran-word.playing {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.3), rgba(25, 135, 84, 0.15));
        box-shadow: 0 0 15px rgba(25, 135, 84, 0.5);
        animation: word-pulse 1s ease-in-out infinite;
    }
    
    @keyframes word-pulse {
        0%, 100% { box-shadow: 0 0 10px rgba(25, 135, 84, 0.4); }
        50% { box-shadow: 0 0 20px rgba(25, 135, 84, 0.7); }
    }
    
    .word-arabic {
        font-family: var(--arabic-font);
        font-size: var(--arabic-text-size);
        line-height: 1.4;
        color: inherit;
    }
    
    .word-number {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 10px;
        position: absolute;
        top: -8px;
        right: -4px;
        font-family: system-ui, sans-serif;
        min-width: 18px;
        text-align: center;
    }
    
    .word-bangla {
        font-size: 0.75rem;
        color: #198754;
        margin-top: 4px;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
        text-align: center;
        direction: ltr;
    }
    
    /* Always show translation when word-by-word mode is enabled */
    .arabic-text.word-by-word .word-bangla {
        opacity: 1;
        max-height: 50px;
    }
    
    /* Word actions container */
    .word-actions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .quran-word:hover .word-actions {
        opacity: 1;
    }
    
    /* Word search button */
    .word-search-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        padding: 0;
        border: 1px solid #198754;
        border-radius: 50%;
        background: rgba(25, 135, 84, 0.1);
        color: #198754;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .word-search-btn:hover {
        background: #198754;
        color: white;
        transform: scale(1.1);
    }
    
    .word-search-btn:active {
        transform: scale(0.95);
    }
    
    /* Dark mode word search button */
    [data-bs-theme="dark"] .word-search-btn {
        border-color: #75b798;
        background: rgba(117, 183, 152, 0.1);
        color: #75b798;
    }
    
    [data-bs-theme="dark"] .word-search-btn:hover {
        background: #75b798;
        color: #212529;
    }

    .quran-word:hover .word-bangla,
    .quran-word.show-translation .word-bangla {
        opacity: 1;
        max-height: 50px;
    }
    
    /* Dark mode adjustments */
    [data-bs-theme="dark"] .quran-word:hover {
        background: rgba(25, 135, 84, 0.2);
    }
    
    [data-bs-theme="dark"] .quran-word.playing {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.4), rgba(25, 135, 84, 0.2));
    }
    
    [data-bs-theme="dark"] .word-bangla {
        color: #75b798;
    }
    
    /* Word audio indicator */
    .quran-word::before {
        content: '';
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #198754;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .quran-word:hover::before {
        opacity: 0.5;
    }
    
    .quran-word.playing::before {
        opacity: 1;
        animation: dot-pulse 0.5s ease-in-out infinite;
    }
    
    @keyframes dot-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.5); }
    }
    
    /* Loading state for words */
    .arabic-text.loading-words {
        opacity: 0.5;
    }
    
    .arabic-text.loading-words::after {
        content: 'Loading word-by-word...';
        display: block;
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 8px;
        font-family: system-ui;
        direction: ltr;
        text-align: center;
    }
    
    /* Word tooltip (alternative to inline) */
    .word-tooltip {
        position: fixed;
        background: #1a1a2e;
        color: #fff;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 0.85rem;
        z-index: 9999;
        pointer-events: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transform: translateX(-50%);
        white-space: nowrap;
        border: 1px solid #198754;
    }
    
    .word-tooltip::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid #1a1a2e;
    }
    
    [data-bs-theme="light"] .word-tooltip {
        background: #fff;
        color: #333;
        border-color: #198754;
    }
    
    [data-bs-theme="light"] .word-tooltip::after {
        border-top-color: #fff;
    }
    
    /* Double-click hint */
    .word-hint {
        position: fixed;
        bottom: 160px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(25, 135, 84, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        animation: hint-fade 3s ease forwards;
        pointer-events: none;
    }
    
    @keyframes hint-fade {
        0%, 70% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    /* Toggle button for word-by-word */
    .word-by-word-toggle {
        font-size: 0.85rem;
    }
    
    .word-by-word-toggle .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }
</style>

<script>
    // Pagination functionality
    (function() {
        const ayahItems = document.querySelectorAll('.ayah-item');
        
        // Handle hash-based ayah highlighting for surahs with 20 or fewer ayahs (no pagination)
        if (ayahItems.length <= 20) {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#ayah-')) {
                const ayahNumber = parseInt(hash.replace('#ayah-', ''));
                setTimeout(() => {
                    const ayahCard = document.getElementById(`ayah-${ayahNumber}`);
                    if (ayahCard) {
                        // Scroll to the ayah
                        ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Add highlight effect
                        ayahCard.classList.add('shared-highlight');
                        
                        // Remove highlight after a few seconds
                        setTimeout(() => {
                            ayahCard.classList.remove('shared-highlight');
                        }, 5000);
                    }
                }, 300);
            }
            return; // No pagination needed
        }
        
        const perPageSelect = document.getElementById('ayahsPerPage');
        const pageInfo = document.getElementById('pageInfo');
        const paginationTop = document.getElementById('paginationTop');
        const paginationBottom = document.getElementById('paginationBottom');
        
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // Load saved preference
        const savedPerPage = localStorage.getItem('ayahsPerPage');
        if (savedPerPage) {
            perPageSelect.value = savedPerPage;
            itemsPerPage = savedPerPage === 'all' ? ayahItems.length : parseInt(savedPerPage);
        }
        
        // Get page from URL
        function getPageFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get('page'));
            return page && page > 0 ? page : 1;
        }
        
        // Update URL with page number
        function updateUrl(page) {
            const url = new URL(window.location);
            if (page > 1) {
                url.searchParams.set('page', page);
            } else {
                url.searchParams.delete('page');
            }
            window.history.pushState({page: page}, '', url);
        }
        
        function getTotalPages() {
            return Math.ceil(ayahItems.length / itemsPerPage);
        }
        
        function showPage(page, updateHistory = true) {
            const totalPages = getTotalPages();
            // Clamp page to valid range
            page = Math.max(1, Math.min(page, totalPages));
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            ayahItems.forEach((item, index) => {
                if (itemsPerPage === ayahItems.length || (index >= start && index < end)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
            
            updatePageInfo();
            renderPagination();
            
            // Update URL
            if (updateHistory) {
                updateUrl(page);
            }
            
            // Scroll to top of ayahs
            document.getElementById('ayahsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updatePageInfo() {
            const totalPages = getTotalPages();
            if (itemsPerPage === ayahItems.length) {
                pageInfo.textContent = `‡¶∏‡¶¨ ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§`;
            } else {
                const start = (currentPage - 1) * itemsPerPage + 1;
                const end = Math.min(currentPage * itemsPerPage, ayahItems.length);
                pageInfo.textContent = `${start}-${end} / ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ (‡¶™‡ßá‡¶ú ${currentPage}/${totalPages})`;
            }
        }
        
        function renderPagination() {
            const totalPages = getTotalPages();
            if (totalPages <= 1) {
                paginationTop.innerHTML = '';
                paginationBottom.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage - 1}">&laquo;</a>
            </li>`;
            
            // Page numbers with ellipsis
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" data-page="1">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" data-page="${i}">${i}</a>
                </li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" data-page="${totalPages}">${totalPages}</a></li>`;
            }
            
            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage + 1}">&raquo;</a>
            </li>`;
            
            paginationTop.innerHTML = html;
            paginationBottom.innerHTML = html;
            
            // Add click handlers
            document.querySelectorAll('.pagination .page-link[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.dataset.page);
                    if (page >= 1 && page <= totalPages) {
                        showPage(page);
                    }
                });
            });
        }
        
        // Handle per-page change
        perPageSelect.addEventListener('change', () => {
            const value = perPageSelect.value;
            localStorage.setItem('ayahsPerPage', value);
            itemsPerPage = value === 'all' ? ayahItems.length : parseInt(value);
            currentPage = 1;
            showPage(1);
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', (e) => {
            const page = e.state?.page || getPageFromUrl();
            showPage(page, false);
        });
        
        // Initialize with page from URL or navigate to ayah from hash
        const hash = window.location.hash;
        if (hash && hash.startsWith('#ayah-')) {
            const ayahNumber = parseInt(hash.replace('#ayah-', ''));
            
            // Find the index of this ayah in the ayahItems NodeList
            let ayahIndex = -1;
            ayahItems.forEach((item, index) => {
                if (parseInt(item.dataset.ayahNumber) === ayahNumber) {
                    ayahIndex = index;
                }
            });
            
            if (ayahIndex >= 0) {
                // Calculate which page this ayah is on
                const targetPage = Math.floor(ayahIndex / itemsPerPage) + 1;
                showPage(targetPage, false);
                
                // Highlight the ayah after a short delay
                setTimeout(() => {
                    const ayahCard = document.getElementById(`ayah-${ayahNumber}`);
                    if (ayahCard) {
                        // Scroll to the ayah
                        ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Add highlight effect
                        ayahCard.classList.add('shared-highlight');
                        
                        // Remove highlight after a few seconds
                        setTimeout(() => {
                            ayahCard.classList.remove('shared-highlight');
                        }, 5000);
                    }
                }, 300);
            } else {
                const initialPage = getPageFromUrl();
                showPage(initialPage, false);
            }
        } else {
            const initialPage = getPageFromUrl();
            showPage(initialPage, false);
        }
    })();
    
    // Translation visibility and ordering
    (function() {
        const translationCheckboxes = document.querySelectorAll('.translation-checkbox');
        const translationOrderSelects = document.querySelectorAll('.translation-order-select');
        
        // Load saved preferences
        const savedPrefs = JSON.parse(localStorage.getItem('translationPrefs') || '{"sahih":false,"mujibur":false,"rawai":true,"taisirul":false,"zakaria":false}');
        const savedOrders = JSON.parse(localStorage.getItem('translationOrders') || '{}');
        
        // Apply saved preferences for checkboxes
        translationCheckboxes.forEach(checkbox => {
            const translationType = checkbox.dataset.translation;
            if (savedPrefs[translationType] !== undefined) {
                checkbox.checked = savedPrefs[translationType];
            }
        });
        
        // Apply saved order preferences
        translationOrderSelects.forEach(select => {
            const translationType = select.dataset.translation;
            if (savedOrders[translationType] !== undefined) {
                select.value = savedOrders[translationType];
            }
        });
        
        // Initial update of visibility and order
        updateAllTranslations();
        
        // Handle checkbox changes
        translationCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const translationType = this.dataset.translation;
                const isChecked = this.checked;
                
                // Save preference
                savedPrefs[translationType] = isChecked;
                localStorage.setItem('translationPrefs', JSON.stringify(savedPrefs));
                
                // Update visibility and order
                updateAllTranslations();
            });
        });
        
        // Handle order changes
        translationOrderSelects.forEach(select => {
            select.addEventListener('change', function() {
                const translationType = this.dataset.translation;
                const newOrder = parseInt(this.value);
                
                // Save order preference
                savedOrders[translationType] = newOrder;
                localStorage.setItem('translationOrders', JSON.stringify(savedOrders));
                
                // Update visibility and order
                updateAllTranslations();
            });
        });
        
        function getTranslationOrder(translationId) {
            // First check saved orders
            if (savedOrders[translationId] !== undefined) {
                return savedOrders[translationId];
            }
            // Then check the select element
            const select = document.querySelector(`.translation-order-select[data-translation="${translationId}"]`);
            return select ? parseInt(select.value) : 999;
        }
        
        function isTranslationVisible(translationId) {
            // First check saved preferences
            if (savedPrefs[translationId] !== undefined) {
                return savedPrefs[translationId];
            }
            // Then check the checkbox
            const checkbox = document.querySelector(`.translation-checkbox[data-translation="${translationId}"]`);
            return checkbox ? checkbox.checked : false;
        }
        
        function updateAllTranslations() {
            // Get all translation containers
            const containers = document.querySelectorAll('.translations-container');
            
            containers.forEach(container => {
                const items = container.querySelectorAll('.translation-item');
                
                // Collect all items with their order and visibility
                const itemsArray = Array.from(items).map(item => {
                    const translationId = item.dataset.translationId;
                    const language = item.dataset.language;
                    return {
                        element: item,
                        translationId: translationId,
                        language: language,
                        order: getTranslationOrder(translationId),
                        visible: isTranslationVisible(translationId)
                    };
                });
                
                // Sort by language first (bangla before english), then by order
                itemsArray.sort((a, b) => {
                    // First sort by language (bangla = 0, english = 1)
                    const langOrder = { 'bangla': 0, 'english': 1 };
                    const langDiff = (langOrder[a.language] || 2) - (langOrder[b.language] || 2);
                    if (langDiff !== 0) return langDiff;
                    // Then sort by order within same language
                    return a.order - b.order;
                });
                
                // Reorder elements in DOM and update visibility
                itemsArray.forEach(item => {
                    // Update visibility
                    item.element.style.display = item.visible ? 'block' : 'none';
                    // Append to container to reorder
                    container.appendChild(item.element);
                });
            });
        }
    })();
    
    // ============================================
    // WORD-BY-WORD FUNCTIONALITY
    // ============================================
    (function() {
        const wordByWordToggle = document.getElementById('wordByWordToggle');
        const wordAudio = new Audio();
        let wordByWordEnabled = true; // Default to true (matches UI default)
        let wordDataCache = {};
        let currentPlayingWord = null;
        let hintShown = false;
        
        // Load saved preference (default to true if not set)
        const savedWordByWord = localStorage.getItem('wordByWordEnabled');
        if (savedWordByWord === null) {
            // No saved preference, use default (enabled)
            localStorage.setItem('wordByWordEnabled', 'true');
            wordByWordToggle.checked = true;
            wordByWordEnabled = true;
            initWordByWord();
        } else if (savedWordByWord === 'true') {
            wordByWordToggle.checked = true;
            wordByWordEnabled = true;
            initWordByWord();
        } else {
            wordByWordToggle.checked = false;
            wordByWordEnabled = false;
        }
        
        // Toggle handler
        wordByWordToggle.addEventListener('change', function() {
            wordByWordEnabled = this.checked;
            localStorage.setItem('wordByWordEnabled', wordByWordEnabled);
            
            if (wordByWordEnabled) {
                initWordByWord();
            } else {
                disableWordByWord();
            }
        });
        
        // Initialize word-by-word for all visible ayahs
        function initWordByWord() {
            const ayahItems = document.querySelectorAll('.ayah-item:not(.hidden)');
            ayahItems.forEach(ayahItem => {
                const ayahNumber = ayahItem.dataset.ayahNumber;
                loadWordByWordData(surahId, ayahNumber);
            });
            
            // Show hint on first enable
            if (!hintShown && !localStorage.getItem('wordHintShown')) {
                showHint();
                hintShown = true;
                localStorage.setItem('wordHintShown', 'true');
            }
        }
        
        // Disable word-by-word mode
        function disableWordByWord() {
            document.querySelectorAll('.arabic-text.word-by-word').forEach(el => {
                const ayahNumber = el.id.replace('arabic-', '');
                const originalText = el.dataset.originalText;
                if (originalText) {
                    el.innerHTML = originalText;
                    el.classList.remove('word-by-word');
                }
            });
        }
        
        // Show hint tooltip
        function showHint() {
            const hint = document.createElement('div');
            hint.className = 'word-hint';
            hint.innerHTML = '<i class="bi bi-hand-index me-2"></i>‡¶°‡¶æ‡¶¨‡¶≤ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∂‡¶¨‡ßç‡¶¶ ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶® ‚Ä¢ Hover ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶∞‡ßç‡¶• ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
            document.body.appendChild(hint);
            setTimeout(() => hint.remove(), 3000);
        }
        
        // Fetch word-by-word data from Quran.com API
        async function loadWordByWordData(surahId, ayahNumber) {
            const cacheKey = `${surahId}:${ayahNumber}`;
            const arabicEl = document.getElementById(`arabic-${ayahNumber}`);
            
            if (!arabicEl) return;
            
            // Store original text
            if (!arabicEl.dataset.originalText) {
                arabicEl.dataset.originalText = arabicEl.innerHTML;
            }
            
            // Check cache
            if (wordDataCache[cacheKey]) {
                renderWordByWord(arabicEl, wordDataCache[cacheKey], ayahNumber);
                return;
            }
            
            arabicEl.classList.add('loading-words');
            
            try {
                // Fetch from Quran.com API (word-by-word with translations)
                const response = await fetch(
                    `https://api.quran.com/api/v4/verses/by_key/${surahId}:${ayahNumber}?language=bn&words=true&word_fields=text_uthmani,text_indopak&translations=97`
                );
                
                if (!response.ok) throw new Error('Failed to fetch word data');
                
                const data = await response.json();
                const words = data.verse?.words || [];
                
                // Cache the data
                wordDataCache[cacheKey] = words;
                
                renderWordByWord(arabicEl, words, ayahNumber);
            } catch (error) {
                console.error('Word-by-word fetch error:', error);
                arabicEl.classList.remove('loading-words');
            }
        }
        
        // Render word-by-word view
        function renderWordByWord(container, words, ayahNumber) {
            container.classList.remove('loading-words');
            container.classList.add('word-by-word');
            
            // Filter out end markers and build word elements
            const wordElements = words
                .filter(word => word.char_type_name === 'word') // Only actual words, not end markers
                .map((word, index) => {

                    const wordPosition = index + 1;
                    const arabicText = word.text_uthmani || word.text || '';
                    const banglaTranslation = word.translation?.text || '';

                    return `
                        <span class="quran-word" 
                              data-surah="${surahId}" 
                              data-ayah="${ayahNumber}" 
                              data-word="${wordPosition}"
                              data-arabic="${arabicText}"
                              data-bangla="${banglaTranslation}">
                            <span class="word-number badge bg-success">${wordPosition}</span>
                            <span class="word-arabic">${arabicText}</span>
                            <span class="word-bangla">${banglaTranslation}</span>
                            <span class="word-actions">
                                <button class="word-search-btn" title="‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá ‡¶è‡¶á ‡¶∂‡¶¨‡ßç‡¶¶ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®" data-word="${encodeURIComponent(arabicText)}">
                                    <i class="bi bi-search"></i>
                                </button>
                            </span>
                        </span>
                    `;
                }).join('');
            
            // Add the ayah end marker
            const endMarker = words.find(w => w.char_type_name === 'end');
            if (endMarker) {
                // container.innerHTML = wordElements + `<span class="quran-word end-marker" style="cursor: default;"><span class="word-number badge bg-primary">${ayahNumber}</span></span>`;
                container.innerHTML = wordElements;
            } else {
                container.innerHTML = wordElements;
            }
            
            // Add event listeners to words
            container.querySelectorAll('.quran-word:not(.end-marker)').forEach(wordEl => {
                // Double-click for audio
                wordEl.addEventListener('dblclick', playWordAudio);
                
                // Touch support (long press)
                let touchTimer;
                wordEl.addEventListener('touchstart', (e) => {
                    touchTimer = setTimeout(() => {
                        playWordAudio.call(wordEl, e);
                    }, 500);
                });
                wordEl.addEventListener('touchend', () => clearTimeout(touchTimer));
                wordEl.addEventListener('touchmove', () => clearTimeout(touchTimer));
                
                // Search button click
                const searchBtn = wordEl.querySelector('.word-search-btn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const wordToSearch = decodeURIComponent(this.dataset.word);
                        window.location.href = `/search/word?q=${encodeURIComponent(wordToSearch)}`;
                    });
                }
            });
        }
        
        // Play word audio
        function playWordAudio(e) {
            e.preventDefault();
            
            const wordEl = this;
            const surah = wordEl.dataset.surah;
            const ayah = wordEl.dataset.ayah;
            const wordNum = wordEl.dataset.word;
            
            // Generate audio URL (Quran.com CDN format)
            const paddedSurah = String(surah).padStart(3, '0');
            const paddedAyah = String(ayah).padStart(3, '0');
            const paddedWord = String(wordNum).padStart(3, '0');
            const audioUrl = `https://audio.qurancdn.com/wbw/${paddedSurah}_${paddedAyah}_${paddedWord}.mp3`;
            
            // Remove playing state from previous word
            if (currentPlayingWord) {
                currentPlayingWord.classList.remove('playing');
            }
            
            // Add playing state
            wordEl.classList.add('playing');
            currentPlayingWord = wordEl;
            
            // Play audio
            wordAudio.src = audioUrl;
            wordAudio.play().catch(err => {
                console.error('Word audio error:', err);
                wordEl.classList.remove('playing');
            });
        }
        
        // Handle audio end
        wordAudio.addEventListener('ended', () => {
            if (currentPlayingWord) {
                currentPlayingWord.classList.remove('playing');
                currentPlayingWord = null;
            }
        });
        
        // Handle audio error
        wordAudio.addEventListener('error', () => {
            if (currentPlayingWord) {
                currentPlayingWord.classList.remove('playing');
                currentPlayingWord = null;
            }
        });
        
        // Re-initialize when pagination changes
        const observer = new MutationObserver((mutations) => {
            if (wordByWordEnabled) {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.classList && node.classList.contains('ayah-item')) {
                            const ayahNumber = node.dataset.ayahNumber;
                            loadWordByWordData(surahId, ayahNumber);
                        }
                    });
                    // Also check for visibility changes
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.classList.contains('ayah-item') && !target.classList.contains('hidden')) {
                            const ayahNumber = target.dataset.ayahNumber;
                            const arabicEl = document.getElementById(`arabic-${ayahNumber}`);
                            if (arabicEl && !arabicEl.classList.contains('word-by-word')) {
                                loadWordByWordData(surahId, ayahNumber);
                            }
                        }
                    }
                });
            }
        });
        
        const ayahsContainer = document.getElementById('ayahsContainer');
        if (ayahsContainer) {
            observer.observe(ayahsContainer, { 
                childList: true, 
                subtree: true,
                attributes: true,
                attributeFilter: ['class']
            });
        }
    })();
    
    // ============================================
    // SETTINGS PANEL FUNCTIONALITY
    // ============================================
    (function() {
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsOverlay = document.getElementById('settingsPanelOverlay');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsToggleMobile = document.getElementById('settingsToggleMobile');
        const settingsPanelClose = document.getElementById('settingsPanelClose');
        
        // Default settings
        const DEFAULT_SETTINGS = {
            quranFont: 'traditional',
            arabicTextSize: 100,
            translationDisplay: 'bengali'
        };
        
        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('surahSettings');
            return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
        }
        
        // Save settings to localStorage
        function saveSettings(settings) {
            localStorage.setItem('surahSettings', JSON.stringify(settings));
        }
        
        // Initialize settings on page load
        function initializeSettings() {
            const settings = loadSettings();
            
            // Set font
            const fontRadio = document.querySelector(`input[name="quranFont"][value="${settings.quranFont}"]`);
            if (fontRadio) {
                fontRadio.checked = true;
                applyFont(settings.quranFont);
            }
            
            // Set text size
            updateTextSize(settings.arabicTextSize);
            
            // Set translation display
            const displayRadio = document.querySelector(`input[name="translationDisplay"][value="${settings.translationDisplay}"]`);
            if (displayRadio) {
                displayRadio.checked = true;
                applyTranslationDisplay(settings.translationDisplay);
            }
        }
        
        // Apply font to Arabic text
        function applyFont(fontName) {
            const body = document.body;
            const fontClass = `arabic-font-${fontName}`;
            
            // Remove existing font classes
            body.classList.remove('arabic-font-traditional', 'arabic-font-uthmani', 'arabic-font-indopak', 'arabic-font-tajweed');
            
            // Add new font class
            if (fontName !== 'traditional') {
                body.classList.add(fontClass);
            }
            
            // Update CSS variable
            const fontMap = {
                'traditional': "'Traditional Arabic', 'Scheherazade', serif",
                'uthmani': "'Scheherazade New', 'Traditional Arabic', serif",
                'indopak': "'IndoPak', 'Traditional Arabic', serif",
                'tajweed': "'Tajweed', 'Traditional Arabic', serif"
            };
            
            document.documentElement.style.setProperty('--arabic-font', fontMap[fontName] || fontMap['traditional']);
            
            // Save setting
            const settings = loadSettings();
            settings.quranFont = fontName;
            saveSettings(settings);
        }
        
        // Apply text size
        function updateTextSize(size) {
            document.documentElement.style.setProperty('--arabic-text-size', size / 100 * 1.8 + 'rem');
            
            // Update size display
            const sizeDisplay = document.getElementById('sizeDisplay');
            if (sizeDisplay) {
                sizeDisplay.textContent = size + '%';
            }
            
            // Update active preset button
            document.querySelectorAll('.size-preset').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.size) === size) {
                    btn.classList.add('active');
                }
            });
            
            // Save setting
            const settings = loadSettings();
            settings.arabicTextSize = size;
            saveSettings(settings);
        }
        
        // Apply translation display option
        function applyTranslationDisplay(displayMode) {
            const translations = document.querySelectorAll('.translation-item');
            
            // translations.forEach(translation => {
            //     const language = translation.dataset.language;
                
            //     if (displayMode === 'both') {
            //         translation.style.display = '';
            //     } else if (displayMode === 'arabic') {
            //         translation.style.display = 'none';
            //     } else if (displayMode === 'bengali' && language === 'english') {
            //         translation.style.display = 'none';
            //     } else if (displayMode === 'english' && language === 'bangla') {
            //         translation.style.display = 'none';
            //     } else {
            //         translation.style.display = '';
            //     }
            // });
            
            // Save setting
            const settings = loadSettings();
            settings.translationDisplay = displayMode;
            saveSettings(settings);
        }
        
        // Toggle settings panel
        function toggleSettingsPanel() {
            settingsPanel.classList.toggle('active');
            settingsOverlay.classList.toggle('active');
        }
        
        // Close settings panel
        function closeSettingsPanel() {
            settingsPanel.classList.remove('active');
            settingsOverlay.classList.remove('active');
        }
        
        // Event listeners for opening settings
        if (settingsToggle) {
            settingsToggle.addEventListener('click', toggleSettingsPanel);
        }
        if (settingsToggleMobile) {
            settingsToggleMobile.addEventListener('click', function() {
                toggleSettingsPanel();
            });
        }
        
        // Close button
        if (settingsPanelClose) {
            settingsPanelClose.addEventListener('click', closeSettingsPanel);
        }
        
        // Close on overlay click
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', closeSettingsPanel);
        }
        
        // Close on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSettingsPanel();
            }
        });
        
        // Font selection
        document.querySelectorAll('.quran-font-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                applyFont(this.value);
            });
        });
        
        // Text size controls
        document.getElementById('increaseSize')?.addEventListener('click', function() {
            const settings = loadSettings();
            let newSize = Math.min(settings.arabicTextSize + 10, 200);
            updateTextSize(newSize);
        });
        
        document.getElementById('decreaseSize')?.addEventListener('click', function() {
            const settings = loadSettings();
            let newSize = Math.max(settings.arabicTextSize - 10, 50);
            updateTextSize(newSize);
        });
        
        // Size preset buttons
        document.querySelectorAll('.size-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                updateTextSize(parseInt(this.dataset.size));
            });
        });
        
        // Translation display options
        document.querySelectorAll('.translation-display-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                applyTranslationDisplay(this.value);
            });
        });
        
        // Translation selection checkboxes (sync with main card)
        document.querySelectorAll('.settings-body .translation-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const translationId = this.dataset.translation;
                const isChecked = this.checked;
                
                // Sync with main card checkbox if it exists
                const mainCheckbox = document.querySelector(`.translation-checkbox[data-translation="${translationId}"]:not(.settings-body .translation-checkbox)`);
                if (mainCheckbox) {
                    mainCheckbox.checked = isChecked;
                    mainCheckbox.dispatchEvent(new Event('change'));
                }
            });
        });
        
        // Also sync main card checkboxes to settings panel
        document.querySelectorAll('.translation-checkbox:not(.settings-body .translation-checkbox)').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const translationId = this.dataset.translation;
                const isChecked = this.checked;
                
                // Sync with settings checkbox
                const settingsCheckbox = document.querySelector(`.settings-body .translation-checkbox[data-translation="${translationId}"]`);
                if (settingsCheckbox) {
                    settingsCheckbox.checked = isChecked;
                }
            });
        });
        
        // Reset to default
        document.getElementById('resetSettings')?.addEventListener('click', function() {
            if (confirm('Reset all settings to default?')) {
                localStorage.removeItem('surahSettings');
                
                // Reset form
                document.querySelector('input[name="quranFont"][value="traditional"]').checked = true;
                document.querySelector('input[name="translationDisplay"][value="bengali"]').checked = true;
                
                // Apply defaults
                applyFont('traditional');
                updateTextSize(100);
                applyTranslationDisplay('bengali');
                
                // Reload translations from main card
                document.querySelectorAll('.translation-checkbox:not(.settings-body .translation-checkbox)').forEach(checkbox => {
                    checkbox.dispatchEvent(new Event('change'));
                });
            }
        });
        
        // Initialize on load
        initializeSettings();
    })();
</script>