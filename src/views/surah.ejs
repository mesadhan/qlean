<a href="/" class="btn btn-outline-secondary mb-4">
    <i class="bi bi-arrow-left"></i> Back to Surahs
</a>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0 arabic-text"><%= surah.name %></h3>
                <h5 class="mb-0"><%= surah.transliteration %> - <%= surah.translation %></h5>
            </div>
            <span class="badge bg-light text-dark"><%= surah.totalAyahs %> Ayahs</span>
        </div>
    </div>
    
    <!-- Audio Player Section -->
    <div class="card-body border-top">
        <div class="d-flex flex-column gap-3">
            <!-- Audio Type Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <label class="form-label mb-0"><i class="bi bi-translate"></i> Audio Type:</label>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="audioType" id="audioArabic" value="arabic" checked>
                    <label class="btn btn-outline-success btn-sm" for="audioArabic">‡¶Ü‡¶∞‡¶¨‡¶ø (Arabic)</label>
                    
                    <input type="radio" class="btn-check" name="audioType" id="audioBangla" value="bangla">
                    <label class="btn btn-outline-success btn-sm" for="audioBangla">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bangla)</label>
                    
                    <input type="radio" class="btn-check" name="audioType" id="audioEnglish" value="english">
                    <label class="btn btn-outline-success btn-sm" for="audioEnglish">English</label>
                    
                    <input type="radio" class="btn-check" name="audioType" id="audioBoth" value="both">
                    <label class="btn btn-outline-success btn-sm" for="audioBoth">Arabic + Translation</label>
                </div>
            </div>
            
            <!-- Arabic Reciter Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap" id="arabicReciterSection">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ï‡¶æ‡¶∞‡ßÄ:</label>
                <select class="form-select form-select-sm" id="reciterSelect" style="max-width: 280px;">
                    <option value="Alafasy_128kbps">Mishary Rashid Alafasy</option>
                    <option value="Abdul_Basit_Murattal_192kbps">Abdul Basit (Murattal)</option>
                    <option value="Abdul_Basit_Mujawwad_128kbps">Abdul Basit (Mujawwad)</option>
                    <option value="Husary_128kbps">Mahmoud Khalil Al-Husary</option>
                    <option value="Minshawy_Murattal_128kbps">Mohamed Siddiq El-Minshawi</option>
                    <option value="Ahmed_ibn_Ali_al_Ajamy_128kbps_ketaballah.net">Ahmed ibn Ali al-Ajamy</option>
                    <option value="Muhammad_Ayyoub_128kbps">Muhammad Ayyoub</option>
                    <option value="Muhammad_Jibreel_128kbps">Muhammad Jibreel</option>
                    <option value="Maher_AlMuworrkly_128kbps">Maher Al-Muaiqly</option>
                    <option value="Saood_ash-Shuraym_128kbps">Saood Ash-Shuraym</option>
                </select>
            </div>
            
            <!-- Bangla Translation Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap" id="banglaReciterSection" style="display: none;">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶:</label>
                <select class="form-select form-select-sm" id="banglaReciterSelect" style="max-width: 300px;">
                    <option value="bn.bengali">‡¶Æ‡ßÅ‡¶π‡¶ø‡¶â‡¶¶‡ßç‡¶¶‡ßÄ‡¶® ‡¶ñ‡¶æ‡¶®</option>
                    <option value="bn.hoque">‡¶ú‡¶π‡ßÅ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï</option>
                </select>
            </div>
            
            <!-- English Translation Selection -->
            <div class="d-flex align-items-center gap-2 flex-wrap" id="englishReciterSection" style="display: none;">
                <label class="form-label mb-0"><i class="bi bi-person-circle"></i> English Translator:</label>
                <select class="form-select form-select-sm" id="englishReciterSelect" style="max-width: 300px;">
                    <option value="en.sahih">Sahih International</option>
                    <option value="en.pickthall">Pickthall</option>
                    <option value="en.yusufali">Yusuf Ali</option>
                    <option value="en.arberry">Arberry</option>
                    <option value="en.sarwar">Muhammad Sarwar</option>
                    <option value="en.shakir">Shakir</option>
                </select>
            </div>
            
            <!-- Full Surah Player -->
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <button class="btn btn-success" id="playSurahBtn">
                    <i class="bi bi-play-fill"></i> Play Full Surah
                </button>
                <button class="btn btn-outline-secondary" id="stopSurahBtn" style="display: none;">
                    <i class="bi bi-stop-fill"></i> Stop
                </button>
                <span id="nowPlaying" class="text-muted small"></span>
            </div>
            
            <!-- Audio Element for Full Surah -->
            <audio id="surahAudio" class="w-100" controls style="display: none;"></audio>
        </div>
    </div>
</div>

<!-- Pagination Controls (Top) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-between align-items-center mb-3 pagination-controls flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0 small">‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§/‡¶™‡ßá‡¶ú:</label>
        <select class="form-select form-select-sm" id="ayahsPerPage" style="width: auto;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">‡¶∏‡¶¨</option>
        </select>
    </div>
    <span class="text-muted small" id="pageInfo"></span>
    <nav aria-label="Ayah pagination">
        <ul class="pagination pagination-sm mb-0" id="paginationTop"></ul>
    </nav>
</div>
<% } %>

<!-- Ayahs Container -->
<div id="ayahsContainer">
<!-- Ayahs with individual play buttons -->
<% if (surah.ayahs && surah.ayahs.length > 0) { %>
    <% surah.ayahs.forEach(ayah => { %>
        <div class="card ayah-card ayah-item" id="ayah-<%= ayah.number %>" data-ayah-number="<%= ayah.number %>">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success"><%= ayah.number %></span>
                        <button class="btn btn-sm btn-outline-success play-ayah-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                title="Play this Ayah">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary share-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-surah-name="<%= surah.transliteration %>"
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translation %>"
                                title="Share this Ayah">
                            <i class="bi bi-share"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning bookmark-btn" 
                                data-surah-id="<%= surah.id %>" 
                                data-ayah-number="<%= ayah.number %>"
                                data-ayah-text="<%= ayah.text %>"
                                data-ayah-translation="<%= ayah.translation %>"
                                title="Bookmark this Ayah">
                            <i class="bi bi-bookmark"></i>
                        </button>
                    </div>
                </div>
                <p class="arabic-text" id="arabic-<%= ayah.number %>"><%= ayah.text %></p>
                <p class="translation-text bangla-translation">
                    <span class="badge bg-info me-1">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span> <%= ayah.translation %>
                </p>
                <% if (ayah.englishTranslation) { %>
                <p class="translation-text english-translation text-muted">
                    <span class="badge bg-secondary me-1">English</span> <%= ayah.englishTranslation %>
                </p>
                <% } %>
            </div>
        </div>
    <% }) %>
<% } else { %>
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        Could not load ayahs. Please try refreshing the page or check your internet connection.
    </div>
<% } %>
</div>

<!-- Pagination Controls (Bottom) -->
<% if (surah.ayahs && surah.ayahs.length > 20) { %>
<div class="d-flex justify-content-center mt-3">
    <nav aria-label="Ayah pagination bottom">
        <ul class="pagination" id="paginationBottom"></ul>
    </nav>
</div>
<% } %>

<!-- Hidden audio element for ayah playback -->
<audio id="ayahAudio"></audio>

<script>
    // Surah and ayah counts for audio URL generation
    const SURAH_AYAH_COUNTS = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6];
    
    const surahId = <%= surah.id %>;
    const totalAyahs = <%= surah.totalAyahs %>;
    
    // Calculate global ayah number
    function getGlobalAyahNumber(surahId, ayahNumber) {
        let globalNumber = 0;
        for (let i = 0; i < surahId - 1; i++) {
            globalNumber += SURAH_AYAH_COUNTS[i];
        }
        return globalNumber + ayahNumber;
    }
    
    // Get Arabic ayah audio URL (everyayah.com - reliable source)
    function getArabicAyahAudioUrl(surahId, ayahNumber, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        return `https://everyayah.com/data/${reciterFolder}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get Bangla translation audio URL
    // Note: Bangla Quran audio is limited, using Urdu translation as fallback
    function getBanglaAyahAudioUrl(surahId, ayahNumber, translationId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Urdu translation is closest available to Bangla
        return `https://everyayah.com/data/translations/urdu_shamshad_ali_khan_46kbps/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get English translation audio URL (everyayah.com)
    function getEnglishAyahAudioUrl(surahId, ayahNumber, translationId) {
        const paddedSurah = String(surahId).padStart(3, '0');
        const paddedAyah = String(ayahNumber).padStart(3, '0');
        // Map translation IDs to EveryAyah folder names
        const translationMap = {
            'en.sahih': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps',
            'en.pickthall': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps',
            'en.yusufali': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps',
            'en.arberry': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps',
            'en.sarwar': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps',
            'en.shakir': 'English/Sahih_Intnl_Ibrahim_Walk_192kbps'
        };
        const folder = translationMap[translationId] || 'English/Sahih_Intnl_Ibrahim_Walk_192kbps';
        return `https://everyayah.com/data/${folder}/${paddedSurah}${paddedAyah}.mp3`;
    }
    
    // Get full surah audio URL (quranicaudio.com)
    function getSurahAudioUrl(surahId, reciterFolder) {
        const paddedSurah = String(surahId).padStart(3, '0');
        return `https://download.quranicaudio.com/quran/${reciterFolder}/${paddedSurah}.mp3`;
    }
    
    // Audio elements
    const surahAudio = document.getElementById('surahAudio');
    const ayahAudio = document.getElementById('ayahAudio');
    const reciterSelect = document.getElementById('reciterSelect');
    const banglaReciterSelect = document.getElementById('banglaReciterSelect');
    const englishReciterSelect = document.getElementById('englishReciterSelect');
    const playSurahBtn = document.getElementById('playSurahBtn');
    const stopSurahBtn = document.getElementById('stopSurahBtn');
    const nowPlaying = document.getElementById('nowPlaying');
    const arabicReciterSection = document.getElementById('arabicReciterSection');
    const banglaReciterSection = document.getElementById('banglaReciterSection');
    const englishReciterSection = document.getElementById('englishReciterSection');
    
    // Audio type radio buttons
    const audioTypeRadios = document.querySelectorAll('input[name="audioType"]');
    
    let currentlyPlayingAyah = null;
    let isPlayingSequence = false;
    let currentAudioType = 'arabic';
    let isPlayingTranslationAfterArabic = false;
    
    // Hidden audio element for translation playback in "Both" mode
    const translationAudio = document.createElement('audio');
    translationAudio.id = 'translationAudio';
    document.body.appendChild(translationAudio);
    
    // Get current audio type
    function getAudioType() {
        const selected = document.querySelector('input[name="audioType"]:checked');
        return selected ? selected.value : 'arabic';
    }
    
    // Get translation language for "both" mode
    function getTranslationLanguage() {
        return localStorage.getItem('translationLanguage') || 'english';
    }
    
    // Handle audio type change
    audioTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            currentAudioType = getAudioType();
            
            // Show/hide reciter sections based on selection
            arabicReciterSection.style.display = 'none';
            banglaReciterSection.style.display = 'none';
            englishReciterSection.style.display = 'none';
            
            if (currentAudioType === 'arabic') {
                arabicReciterSection.style.display = 'flex';
            } else if (currentAudioType === 'bangla') {
                banglaReciterSection.style.display = 'flex';
            } else if (currentAudioType === 'english') {
                englishReciterSection.style.display = 'flex';
            } else { // both - Arabic + selected translation
                arabicReciterSection.style.display = 'flex';
                englishReciterSection.style.display = 'flex';
                banglaReciterSection.style.display = 'flex';
            }
            
            // Save preference
            localStorage.setItem('audioType', currentAudioType);
        });
    });
    
    // Load saved audio type preference
    const savedAudioType = localStorage.getItem('audioType') || 'arabic';
    const savedRadio = document.querySelector(`input[name="audioType"][value="${savedAudioType}"]`);
    if (savedRadio) {
        savedRadio.checked = true;
        savedRadio.dispatchEvent(new Event('change'));
    }
    
    // Load saved reciter preference (with migration from old format)
    const savedReciter = localStorage.getItem('preferredReciter');
    if (savedReciter) {
        // Check if it's an old format value and migrate
        const oldToNewMap = {
            'ar.alafasy': 'Alafasy_128kbps',
            'ar.abdulbasitmurattal': 'Abdul_Basit_Murattal_192kbps',
            'ar.abdulsamad': 'Abdul_Basit_Mujawwad_128kbps',
            'ar.husary': 'Husary_128kbps',
            'ar.minshawi': 'Minshawy_Murattal_128kbps',
            'ar.ahmedajamy': 'Ahmed_ibn_Ali_al_Ajamy_128kbps_ketaballah.net',
            'ar.muhammadayyoub': 'Muhammad_Ayyoub_128kbps',
            'ar.muhammadjibreel': 'Muhammad_Jibreel_128kbps'
        };
        const newValue = oldToNewMap[savedReciter] || savedReciter;
        reciterSelect.value = newValue;
        // Update storage with new format
        if (oldToNewMap[savedReciter]) {
            localStorage.setItem('preferredReciter', newValue);
        }
    }
    
    // Ensure a valid default is selected
    if (!reciterSelect.value) {
        reciterSelect.value = 'Alafasy_128kbps';
    }
    
    // Save reciter preference
    reciterSelect.addEventListener('change', () => {
        localStorage.setItem('preferredReciter', reciterSelect.value);
    });
    
    // Play full surah (Arabic only - translations play ayah by ayah)
    playSurahBtn.addEventListener('click', () => {
        const audioType = getAudioType();
        
        if (audioType === 'bangla' || audioType === 'english') {
            // For translations, play ayah by ayah starting from first
            const firstAyahBtn = document.querySelector('.play-ayah-btn[data-ayah-number="1"]');
            if (firstAyahBtn) {
                firstAyahBtn.click();
            }
            return;
        }
        
        const reciterId = reciterSelect.value;
        const audioUrl = getSurahAudioUrl(surahId, reciterId);
        
        surahAudio.src = audioUrl;
        surahAudio.style.display = 'block';
        surahAudio.play();
        
        playSurahBtn.style.display = 'none';
        stopSurahBtn.style.display = 'inline-block';
        nowPlaying.textContent = audioType === 'both' ? 'Playing full surah (Arabic)...' : 'Playing full surah...';
    });
    
    // Stop surah
    stopSurahBtn.addEventListener('click', () => {
        surahAudio.pause();
        surahAudio.currentTime = 0;
        surahAudio.style.display = 'none';
        
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // When surah audio ends
    surahAudio.addEventListener('ended', () => {
        playSurahBtn.style.display = 'inline-block';
        stopSurahBtn.style.display = 'none';
        nowPlaying.textContent = '';
    });
    
    // Play individual ayah
    document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const audioType = getAudioType();
            const arabicReciterId = reciterSelect.value || 'Alafasy_128kbps';
            const banglaTranslationId = banglaReciterSelect.value;
            const englishTranslationId = englishReciterSelect.value;
            
            console.log('Playing ayah:', ayahNumber, 'Reciter:', arabicReciterId, 'Type:', audioType);
            
            // Stop surah audio if playing
            surahAudio.pause();
            playSurahBtn.style.display = 'inline-block';
            stopSurahBtn.style.display = 'none';
            surahAudio.style.display = 'none';
            
            // Reset translation state
            isPlayingTranslationAfterArabic = false;
            translationAudio.pause();
            
            // Reset previous playing button and card highlight
            if (currentlyPlayingAyah) {
                const prevBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
                if (prevBtn) {
                    prevBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    prevBtn.classList.remove('btn-success', 'playing');
                    prevBtn.classList.add('btn-outline-success');
                }
                const prevCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
                if (prevCard) {
                    prevCard.classList.remove('playing', 'border-success');
                }
            }
            
            // If clicking same ayah, toggle
            if (currentlyPlayingAyah === ayahNumber && !ayahAudio.paused) {
                ayahAudio.pause();
                translationAudio.pause();
                btn.innerHTML = '<i class="bi bi-play-fill"></i>';
                btn.classList.remove('btn-success', 'playing');
                btn.classList.add('btn-outline-success');
                document.getElementById(`ayah-${ayahNumber}`).classList.remove('playing', 'border-success');
                currentlyPlayingAyah = null;
                nowPlaying.textContent = '';
                return;
            }
            
            // Determine which audio to play based on type
            let audioUrl;
            if (audioType === 'arabic' || audioType === 'both') {
                audioUrl = getArabicAyahAudioUrl(surahId, ayahNumber, arabicReciterId);
            } else if (audioType === 'bangla') {
                audioUrl = getBanglaAyahAudioUrl(surahId, ayahNumber, banglaTranslationId);
            } else if (audioType === 'english') {
                audioUrl = getEnglishAyahAudioUrl(surahId, ayahNumber, englishTranslationId);
            }
            
            console.log('Audio URL:', audioUrl);
            
            // Play the audio
            ayahAudio.src = audioUrl;
            ayahAudio.play().catch(err => console.error('Play error:', err));
            
            btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
            btn.classList.add('btn-success', 'playing');
            btn.classList.remove('btn-outline-success');
            currentlyPlayingAyah = ayahNumber;
            
            // Set status text based on audio type
            if (audioType === 'both') {
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶§‡ßá‡¶≤‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶§`;
            } else if (audioType === 'bangla') {
                nowPlaying.textContent = `‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber} - ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶`;
            } else if (audioType === 'english') {
                nowPlaying.textContent = `Ayah ${ayahNumber} - English Translation`;
            } else {
                nowPlaying.textContent = `Playing Ayah ${ayahNumber}`;
            }
            
            // Highlight current ayah with playing animation
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
            const currentCard = document.getElementById(`ayah-${ayahNumber}`);
            currentCard.classList.add('playing');
            currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });
    
    // When ayah audio ends
    ayahAudio.addEventListener('ended', () => {
        const audioType = getAudioType();
        const englishTranslationId = englishReciterSelect.value;
        
        // If in "both" mode and Arabic just finished, play English translation
        if (audioType === 'both' && !isPlayingTranslationAfterArabic) {
            isPlayingTranslationAfterArabic = true;
            const translationUrl = getEnglishAyahAudioUrl(surahId, currentlyPlayingAyah, englishTranslationId);
            translationAudio.src = translationUrl;
            translationAudio.play();
            nowPlaying.textContent = `Ayah ${currentlyPlayingAyah} - English Translation`;
            return;
        }
        
        // Reset translation state
        isPlayingTranslationAfterArabic = false;
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah if in sequence mode
        if (currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                // Scroll to next ayah
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // When translation audio ends (for "Both" mode)
    translationAudio.addEventListener('ended', () => {
        isPlayingTranslationAfterArabic = false;
        
        const btn = document.querySelector(`.play-ayah-btn[data-ayah-number="${currentlyPlayingAyah}"]`);
        if (btn) {
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.classList.remove('btn-success', 'playing');
            btn.classList.add('btn-outline-success');
        }
        
        // Remove highlight from current card
        const currentCard = document.getElementById(`ayah-${currentlyPlayingAyah}`);
        if (currentCard) {
            currentCard.classList.remove('playing');
        }
        
        // Auto-play next ayah
        if (currentlyPlayingAyah < totalAyahs) {
            const nextAyah = currentlyPlayingAyah + 1;
            const nextBtn = document.querySelector(`.play-ayah-btn[data-ayah-number="${nextAyah}"]`);
            if (nextBtn) {
                document.getElementById(`ayah-${nextAyah}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => nextBtn.click(), 500);
            }
        } else {
            currentlyPlayingAyah = null;
            nowPlaying.textContent = '';
            document.querySelectorAll('.ayah-card').forEach(card => card.classList.remove('playing', 'border-success'));
        }
    });
    
    // Bookmark functionality
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    
    // Update bookmark button icons on load
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        const surahId = parseInt(btn.dataset.surahId);
        const ayahNumber = parseInt(btn.dataset.ayahNumber);
        const isBookmarked = bookmarks.some(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
        if (isBookmarked) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
        }
    });
    
    // Handle bookmark toggle
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const surahId = parseInt(btn.dataset.surahId);
            const ayahNumber = parseInt(btn.dataset.ayahNumber);
            const text = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            const index = bookmarks.findIndex(b => b.surahId === surahId && b.ayahNumber === ayahNumber);
            
            if (index > -1) {
                bookmarks.splice(index, 1);
                btn.innerHTML = '<i class="bi bi-bookmark"></i>';
            } else {
                bookmarks.push({ surahId, ayahNumber, text, translation });
                btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        });
    });
    
    // Share functionality
    function showShareToast(message) {
        const toast = document.createElement('div');
        toast.className = 'share-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const surahId = btn.dataset.surahId;
            const surahName = btn.dataset.surahName;
            const ayahNumber = btn.dataset.ayahNumber;
            const arabicText = btn.dataset.ayahText;
            const translation = btn.dataset.ayahTranslation;
            
            // Get current page from URL
            const params = new URLSearchParams(window.location.search);
            const currentPage = params.get('page');
            
            // Build URL with page parameter if present
            let shareUrl = `${window.location.origin}/surah/${surahId}`;
            if (currentPage && currentPage !== '1') {
                shareUrl += `?page=${currentPage}`;
            }
            shareUrl += `#ayah-${ayahNumber}`;
            
            const shareText = `üìñ ‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}\n\n${arabicText}\n\n${translation}\n\nüîó ${shareUrl}`;
            
            // Always copy to clipboard first
            await copyToClipboard(shareText, shareUrl);
            
            // Then try Web Share API (mobile-friendly)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `‡¶∏‡ßÇ‡¶∞‡¶æ ${surahName} - ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ${ayahNumber}`,
                        text: shareText,
                        url: shareUrl
                    });
                } catch (err) {
                    // User cancelled or error - clipboard already copied
                }
            }
        });
    });
    
    async function copyToClipboard(text, url) {
        console.log('Copying to clipboard:', url);
        try {
            await navigator.clipboard.writeText(url);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        } catch {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = url;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showShareToast('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìã');
        }
    }
</script>

<style>
    /* Playing ayah card - enhanced highlight */
    .ayah-card.playing {
        border-left: 5px solid #198754 !important;
        background: linear-gradient(90deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.05) 50%, transparent 100%);
        animation: pulse-highlight 2s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(25, 135, 84, 0.4);
        transform: scale(1.01);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Playing indicator bar */
    .ayah-card.playing::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(180deg, #198754, #20c997, #198754);
        animation: gradient-flow 2s linear infinite;
    }
    
    /* Sound wave indicator */
    .ayah-card.playing::after {
        content: 'üîä';
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
        animation: sound-wave 1s ease-in-out infinite;
    }
    
    .ayah-card.playing .arabic-text {
        color: #146c43;
        font-weight: 600;
        animation: text-glow 2s ease-in-out infinite;
    }
    
    [data-bs-theme="dark"] .ayah-card.playing {
        background: linear-gradient(90deg, rgba(25, 135, 84, 0.3) 0%, rgba(25, 135, 84, 0.15) 50%, rgba(25, 135, 84, 0.05) 100%);
        box-shadow: 0 0 30px rgba(25, 135, 84, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.playing .arabic-text {
        color: #75b798;
    }
    
    @keyframes pulse-highlight {
        0%, 100% {
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.3);
        }
        50% {
            box-shadow: 0 0 30px rgba(25, 135, 84, 0.6);
        }
    }
    
    @keyframes gradient-flow {
        0% { background-position: 0% 0%; }
        100% { background-position: 0% 200%; }
    }
    
    @keyframes sound-wave {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    @keyframes text-glow {
        0%, 100% { text-shadow: 0 0 5px rgba(25, 135, 84, 0.3); }
        50% { text-shadow: 0 0 15px rgba(25, 135, 84, 0.6); }
    }
    
    .ayah-card.border-success {
        border-left-color: #198754 !important;
        border-width: 4px;
        background-color: rgba(25, 135, 84, 0.05);
    }
    
    [data-bs-theme="dark"] .ayah-card.border-success {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .ayah-item.hidden {
        display: none !important;
    }
    
    .pagination .page-link {
        cursor: pointer;
    }
    
    /* Now Playing button indicator */
    .play-ayah-btn.playing {
        animation: btn-pulse 1s ease-in-out infinite;
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: white !important;
    }
    
    @keyframes btn-pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
        }
    }
    
    /* Share button styles */
    .share-btn:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Toast notification */
    .share-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #198754;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: toast-slide-up 0.3s ease;
    }
    
    @keyframes toast-slide-up {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* Shared link highlight effect */
    .ayah-card.shared-highlight {
        border: 3px solid #0d6efd !important;
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.2) 0%, rgba(13, 110, 253, 0.1) 50%, rgba(13, 110, 253, 0.05) 100%);
        animation: shared-pulse 1.5s ease-in-out 3;
        box-shadow: 0 0 25px rgba(13, 110, 253, 0.5);
    }
    
    [data-bs-theme="dark"] .ayah-card.shared-highlight {
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.3) 0%, rgba(13, 110, 253, 0.15) 50%, rgba(13, 110, 253, 0.05) 100%);
        box-shadow: 0 0 35px rgba(13, 110, 253, 0.6);
    }
    
    @keyframes shared-pulse {
        0%, 100% {
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.4);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 35px rgba(13, 110, 253, 0.7);
            transform: scale(1.02);
        }
    }
</style>

<script>
    // Pagination functionality
    (function() {
        const ayahItems = document.querySelectorAll('.ayah-item');
        if (ayahItems.length <= 20) return; // No pagination needed
        
        const perPageSelect = document.getElementById('ayahsPerPage');
        const pageInfo = document.getElementById('pageInfo');
        const paginationTop = document.getElementById('paginationTop');
        const paginationBottom = document.getElementById('paginationBottom');
        
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // Load saved preference
        const savedPerPage = localStorage.getItem('ayahsPerPage');
        if (savedPerPage) {
            perPageSelect.value = savedPerPage;
            itemsPerPage = savedPerPage === 'all' ? ayahItems.length : parseInt(savedPerPage);
        }
        
        // Get page from URL
        function getPageFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get('page'));
            return page && page > 0 ? page : 1;
        }
        
        // Update URL with page number
        function updateUrl(page) {
            const url = new URL(window.location);
            if (page > 1) {
                url.searchParams.set('page', page);
            } else {
                url.searchParams.delete('page');
            }
            window.history.pushState({page: page}, '', url);
        }
        
        function getTotalPages() {
            return Math.ceil(ayahItems.length / itemsPerPage);
        }
        
        function showPage(page, updateHistory = true) {
            const totalPages = getTotalPages();
            // Clamp page to valid range
            page = Math.max(1, Math.min(page, totalPages));
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            ayahItems.forEach((item, index) => {
                if (itemsPerPage === ayahItems.length || (index >= start && index < end)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
            
            updatePageInfo();
            renderPagination();
            
            // Update URL
            if (updateHistory) {
                updateUrl(page);
            }
            
            // Scroll to top of ayahs
            document.getElementById('ayahsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updatePageInfo() {
            const totalPages = getTotalPages();
            if (itemsPerPage === ayahItems.length) {
                pageInfo.textContent = `‡¶∏‡¶¨ ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§`;
            } else {
                const start = (currentPage - 1) * itemsPerPage + 1;
                const end = Math.min(currentPage * itemsPerPage, ayahItems.length);
                pageInfo.textContent = `${start}-${end} / ${ayahItems.length} ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ (‡¶™‡ßá‡¶ú ${currentPage}/${totalPages})`;
            }
        }
        
        function renderPagination() {
            const totalPages = getTotalPages();
            if (totalPages <= 1) {
                paginationTop.innerHTML = '';
                paginationBottom.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage - 1}">&laquo;</a>
            </li>`;
            
            // Page numbers with ellipsis
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" data-page="1">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" data-page="${i}">${i}</a>
                </li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" data-page="${totalPages}">${totalPages}</a></li>`;
            }
            
            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" data-page="${currentPage + 1}">&raquo;</a>
            </li>`;
            
            paginationTop.innerHTML = html;
            paginationBottom.innerHTML = html;
            
            // Add click handlers
            document.querySelectorAll('.pagination .page-link[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.dataset.page);
                    if (page >= 1 && page <= totalPages) {
                        showPage(page);
                    }
                });
            });
        }
        
        // Handle per-page change
        perPageSelect.addEventListener('change', () => {
            const value = perPageSelect.value;
            localStorage.setItem('ayahsPerPage', value);
            itemsPerPage = value === 'all' ? ayahItems.length : parseInt(value);
            currentPage = 1;
            showPage(1);
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', (e) => {
            const page = e.state?.page || getPageFromUrl();
            showPage(page, false);
        });
        
        // Initialize with page from URL
        const initialPage = getPageFromUrl();
        showPage(initialPage, false);
        
        // Handle hash-based ayah highlighting on page load
        setTimeout(() => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#ayah-')) {
                const ayahNumber = parseInt(hash.replace('#ayah-', ''));
                const ayahCard = document.getElementById(`ayah-${ayahNumber}`);
                if (ayahCard) {
                    // Scroll to the ayah
                    ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add highlight effect
                    ayahCard.classList.add('shared-highlight');
                    
                    // Remove highlight after a few seconds
                    setTimeout(() => {
                        ayahCard.classList.remove('shared-highlight');
                    }, 5000);
                }
            }
        }, 300);
    })();
</script>